(window.webpackJsonp=window.webpackJsonp||[]).push([[154],{502:function(a,t,s){"use strict";s.r(t);var e=s(2),n=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"nginx-实现服务器端集群搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-实现服务器端集群搭建"}},[a._v("#")]),a._v(" Nginx-实现服务器端集群搭建")]),a._v(" "),t("h2",{attrs:{id:"_1-nginx与tomcat部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-nginx与tomcat部署"}},[a._v("#")]),a._v(" 1. Nginx与Tomcat部署")]),a._v(" "),t("p",[a._v("前面课程已经将Nginx的大部分内容进行了讲解，我们都知道了Nginx在高并发场景和处理静态资源是非常高性能的，但是在实际项目中除了静态资源还有就是后台业务代码模块，一般后台业务都会被部署在Tomcat，weblogic或者是websphere等web服务器上。那么如何使用Nginx接收用户的请求并把请求转发到后台web服务器？")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182039279.png",alt:"202303182039279"}})]),a._v(" "),t("p",[a._v("步骤分析:")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[a._v("1.准备Tomcat环境，并在Tomcat上部署一个web项目\n2.准备Nginx环境，使用Nginx接收请求，并把请求分发到Tomat上\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("h3",{attrs:{id:"环境准备-tomcat"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境准备-tomcat"}},[a._v("#")]),a._v(" 环境准备(Tomcat)")]),a._v(" "),t("p",[a._v("浏览器访问:")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("//192.168.200.146:8080/demo/index.html")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182039522.png",alt:"202303182039522"}})]),a._v(" "),t("p",[a._v("获取动态资源的链接地址:")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("//192.168.200.146:8080/demo/getAddress")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("本次课程将采用Tomcat作为后台web服务器")]),a._v(" "),t("p",[a._v("（1）在Centos上准备一个Tomcat")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("1.Tomcat官网地址")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("https://tomcat.apache.org/")]),a._v("\n2.下载tomcat,本次课程使用的是apache-tomcat-8.5.59.tar.gz\n3.将tomcat进行解压缩\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("mkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("web_tomcat")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("tar")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("-zxf apache-tomcat-8.5.59.tar.gz -C /web_tomcat")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("（2）准备一个web项目，将其打包为war")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[a._v("1.将资料中的demo.war上传到tomcat8目录下的webapps包下\n2.将tomcat进行启动，进入tomcat8的bin目录下\n./startup.sh\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("（3）启动tomcat进行访问测试。")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("静态资源")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://192.168.200.146:8080/demo/index.html")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("动态资源")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://192.168.200.146:8080/demo/getAddress")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("h3",{attrs:{id:"环境准备-nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境准备-nginx"}},[a._v("#")]),a._v(" 环境准备(Nginx)")]),a._v(" "),t("p",[a._v("（1）使用Nginx的反向代理，将请求转给Tomcat进行处理。")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("upstream")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("webservice {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("\tserver")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.146:8080;")]),a._v("\n}\nserver{\n    listen\t\t80;\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    server_name")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("localhost;")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    location")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/demo {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    \tproxy_pass")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://webservice;")]),a._v("\n    }\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br")])]),t("p",[a._v("（2）启动访问测试")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041930.png",alt:"1604421312486"}})]),a._v(" "),t("p",[a._v("学习到这，可能大家会有一个困惑，明明直接通过tomcat就能访问，为什么还需要多加一个nginx，这样不是反而是系统的复杂度变高了么?\n那接下来我们从两个方便给大家分析下这个问题，")]),a._v(" "),t("p",[a._v("第一个使用Nginx实现动静分离")]),a._v(" "),t("p",[a._v("第二个使用Nginx搭建Tomcat的集群")]),a._v(" "),t("h2",{attrs:{id:"_2-nginx实现动静分离"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-nginx实现动静分离"}},[a._v("#")]),a._v(" 2. Nginx实现动静分离")]),a._v(" "),t("p",[a._v("什么是动静分离?")]),a._v(" "),t("p",[a._v("动:后台应用程序的业务处理")]),a._v(" "),t("p",[a._v("静:网站的静态资源(html,javaScript,css,images等文件)")]),a._v(" "),t("p",[a._v("分离:将两者进行分开部署访问，提供用户进行访问。举例说明就是以后所有和静态资源相关的内容都交给Nginx来部署访问，非静态内容则交个类似于Tomcat的服务器来部署访问。")]),a._v(" "),t("p",[a._v("为什么要动静分离?")]),a._v(" "),t("p",[a._v("​\t前面我们介绍过Nginx在处理静态资源的时候，效率是非常高的，而且Nginx的并发访问量也是名列前茅，而Tomcat则相对比较弱一些，所以把静态资源交个Nginx后，可以减轻Tomcat服务器的访问压力并提高静态资源的访问速度。")]),a._v(" "),t("p",[a._v("​\t动静分离以后，降低了动态资源和静态资源的耦合度。如动态资源宕机了也不影响静态资源的展示。")]),a._v(" "),t("p",[a._v("如何实现动静分离?")]),a._v(" "),t("p",[a._v("实现动静分离的方式很多，比如静态资源可以部署到CDN、Nginx等服务器上，动态资源可以部署到Tomcat,weblogic或者websphere上。本次课程只要使用Nginx+Tomcat来实现动静分离。")]),a._v(" "),t("h3",{attrs:{id:"需求分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#需求分析"}},[a._v("#")]),a._v(" 需求分析")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041930.png",alt:"1604422564855"}})]),a._v(" "),t("h3",{attrs:{id:"动静分离实现步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#动静分离实现步骤"}},[a._v("#")]),a._v(" 动静分离实现步骤")]),a._v(" "),t("p",[a._v("1.将demo.war项目中的静态资源都删除掉，重新打包生成一个war包，在资料中有提供。")]),a._v(" "),t("p",[a._v("2.将war包部署到tomcat中，把之前部署的内容删除掉")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[a._v("进入到tomcat的webapps目录下，将之前的内容删除掉\n将新的war包复制到webapps下\n将tomcat启动\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("3.在Nginx所在服务器创建如下目录，并将对应的静态资源放入指定的位置")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182043512.png",alt:"1604493947499"}})]),a._v(" "),t("p",[a._v("其中index.html页面的内容如下:")]),a._v(" "),t("div",{staticClass:"language-html line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-html"}},[t("code",[t("span",{pre:!0,attrs:{class:"token doctype"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<!")]),t("span",{pre:!0,attrs:{class:"token doctype-tag"}},[a._v("DOCTYPE")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token name"}},[a._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("html")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("lang")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("en"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("head")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("meta")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("charset")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("UTF-8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("title")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("Title"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("title")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("script")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("src")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("js/jquery.min.js"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token script"}}),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token script"}},[t("span",{pre:!0,attrs:{class:"token language-javascript"}},[a._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n           $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'http://192.168.200.133/demo/getAddress'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[a._v("data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n               "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"#msg"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n           "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    ")])]),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("head")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("img")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("src")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("images/logo.png"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("/>")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("h1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("Nginx如何将请求转发到后端服务器"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("h1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("h3")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("id")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("h3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("img")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("src")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("images/mv.png"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("/>")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br")])]),t("p",[a._v("4.配置Nginx的静态资源与动态资源的访问")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("upstream")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("webservice{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.146:8080;")]),a._v("\n}\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        listen")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("      80;")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        server_name")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v(" localhost;")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("        #动态资源")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        location")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/demo {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("                proxy_pass")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("http://webservice;")]),a._v("\n        }\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("        #静态资源")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        location")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("~/.*\\.(png|jpg|gif|js){")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("                root")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("html/web;")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("                gzip")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("on;")]),a._v("\n        }\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        location")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/ {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("            root")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("  html/web;")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("            index")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v(" index.html index.htm;")]),a._v("\n        }\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br")])]),t("p",[a._v("5.启动测试，访问http://192.168.200.133/index.html")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041512.png",alt:"1604494128097"}})]),a._v(" "),t("p",[a._v("假如某个时间点，由于某个原因导致Tomcat后的服务器宕机了，我们再次访问Nginx,会得到如下效果，用户还是能看到页面，只是缺失了访问次数的统计，这就是前后端耦合度降低的效果，并且整个请求只和后的服务器交互了一次，js和images都直接从Nginx返回，提供了效率，降低了后的服务器的压力。")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041375.png",alt:"1604494156197"}})]),a._v(" "),t("h2",{attrs:{id:"_3-nginx实现tomcat集群搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-nginx实现tomcat集群搭建"}},[a._v("#")]),a._v(" 3. Nginx实现Tomcat集群搭建")]),a._v(" "),t("p",[a._v("在使用Nginx和Tomcat部署项目的时候，我们使用的是一台Nginx服务器和一台Tomcat服务器，效果图如下:")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182043511.png",alt:"1604494256017"}})]),a._v(" "),t("p",[a._v("那么问题来了，如果Tomcat的真的宕机了，整个系统就会不完整，所以如何解决上述问题，一台服务器容易宕机，那就多搭建几台Tomcat服务器，这样的话就提升了后的服务器的可用性。这也就是我们常说的集群，搭建Tomcat的集群需要用到了Nginx的反向代理和赋值均衡的知识，具体如何来实现?我们先来分析下原理")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182043515.png",alt:"1604494269848"}})]),a._v(" "),t("p",[a._v("环境准备：")]),a._v(" "),t("p",[a._v("(1)准备3台tomcat,使用端口进行区分[实际环境应该是三台服务器]，修改server.ml，将端口修改分别修改为8080,8180,8280")]),a._v(" "),t("p",[a._v("(2)启动tomcat并访问测试，")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("//192.168.200.146:8080/demo/getAddress")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041296.png",alt:"1604494822961"}})]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("//192.168.200.146:8180/demo/getAddress")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041239.png",alt:"1604494843886"}})]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("//192.168.200.146:8280/demo/getAddress")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041361.png",alt:"1604494860954"}})]),a._v(" "),t("p",[a._v("(3)在Nginx对应的配置文件中添加如下内容:")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("upstream")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("webservice{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.146:8080;")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.146:8180;")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.146:8280;")]),a._v("\n    }\n\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("p",[a._v("好了，完成了上述环境的部署，我们已经解决了Tomcat的高可用性，一台服务器宕机，还有其他两条对外提供服务，同时也可以实现后台服务器的不间断更新。但是新问题出现了，上述环境中，如果是Nginx宕机了呢，那么整套系统都将服务对外提供服务了，这个如何解决？")]),a._v(" "),t("h2",{attrs:{id:"_4-nginx高可用解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-nginx高可用解决方案"}},[a._v("#")]),a._v(" 4. Nginx高可用解决方案")]),a._v(" "),t("p",[a._v("针对于上面提到的问题，我们来分析下要想解决上述问题，需要面临哪些问题?")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041732.png",alt:"1604495169905"}})]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[a._v("需要两台以上的Nginx服务器对外提供服务，这样的话就可以解决其中一台宕机了，另外一台还能对外提供服务，但是如果是两台Nginx服务器的话，会有两个IP地址，用户该访问哪台服务器，用户怎么知道哪台是好的，哪台是宕机了的?\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("h3",{attrs:{id:"keepalived"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#keepalived"}},[a._v("#")]),a._v(" Keepalived")]),a._v(" "),t("p",[a._v("使用Keepalived来解决，Keepalived 软件由 C 编写的，最初是专为 LVS 负载均衡软件设计的，Keepalived 软件主要是通过 VRRP 协议实现高可用功能。")]),a._v(" "),t("h3",{attrs:{id:"vrrp介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#vrrp介绍"}},[a._v("#")]),a._v(" VRRP介绍")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041753.png",alt:"1604495824757"}})]),a._v(" "),t("p",[a._v("VRRP（Virtual Route Redundancy Protocol）协议，翻译过来为虚拟路由冗余协议。VRRP协议将两台或多台路由器设备虚拟成一个设备，对外提供虚拟路由器IP,而在路由器组内部，如果实际拥有这个对外IP的路由器如果工作正常的话就是MASTER,MASTER实现针对虚拟路由器IP的各种网络功能。其他设备不拥有该虚拟IP，状态为BACKUP,处了接收MASTER的VRRP状态通告信息以外，不执行对外的网络功能。当主机失效时，BACKUP将接管原先MASTER的网络功能。")]),a._v(" "),t("p",[a._v("从上面的介绍信息获取到的内容就是VRRP是一种协议，那这个协议是用来干什么的？")]),a._v(" "),t("p",[a._v("1.选择协议")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("VRRP可以把一个虚拟路由器的责任动态分配到局域网上的")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("VRRP 路由器中的一台。其中的虚拟路由即Virtual路由是由VRRP路由群组创建的一个不真实存在的路由，这个虚拟路由也是有对应的IP地址。而且VRRP路由1和VRRP路由2之间会有竞争选择，通过选择会产生一个Master路由和一个Backup路由。")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("2.路由容错协议")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[a._v("Master路由和Backup路由之间会有一个心跳检测，Master会定时告知Backup自己的状态，如果在指定的时间内，Backup没有接收到这个通知内容，Backup就会替代Master成为新的Master。Master路由有一个特权就是虚拟路由和后端服务器都是通过Master进行数据传递交互的，而备份节点则会直接丢弃这些请求和数据，不做处理，只是去监听Master的状态\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("用了Keepalived后，解决方案如下:")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041083.png",alt:"1604495442179"}})]),a._v(" "),t("h3",{attrs:{id:"环境搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境搭建"}},[a._v("#")]),a._v(" 环境搭建")]),a._v(" "),t("p",[a._v("环境准备")]),a._v(" "),t("table",[t("thead",[t("tr",[t("th",[a._v("VIP")]),a._v(" "),t("th",[a._v("IP")]),a._v(" "),t("th",[a._v("主机名")]),a._v(" "),t("th",[a._v("主/从")])])]),a._v(" "),t("tbody",[t("tr",[t("td"),a._v(" "),t("td",[a._v("192.168.200.133")]),a._v(" "),t("td",[a._v("keepalived1")]),a._v(" "),t("td",[a._v("Master")])]),a._v(" "),t("tr",[t("td",[a._v("192.168.200.222")]),a._v(" "),t("td"),a._v(" "),t("td"),a._v(" "),t("td")]),a._v(" "),t("tr",[t("td"),a._v(" "),t("td",[a._v("192.168.200.122")]),a._v(" "),t("td",[a._v("keepalived2")]),a._v(" "),t("td",[a._v("Backup")])])])]),a._v(" "),t("p",[a._v("keepalived的安装")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("步骤1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("从官方网站下载keepalived,官网地址https://keepalived.org/")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("步骤2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("将下载的资源上传到服务器")]),a._v("\n\tkeepalived-2.0.20.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("步骤3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("创建keepalived目录，方便管理资源")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("\tmkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("keepalived")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("步骤4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("将压缩文件进行解压缩，解压缩到指定的目录")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("\ttar")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("-zxf keepalived-2.0.20.tar.gz -C keepalived/")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("步骤5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("对keepalived进行配置，编译和安装")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("\tcd")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("keepalived/keepalived-2.0.20")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("\t./configure")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("--sysconf=/etc --prefix=/usr/local")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("\tmake")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("&& make install")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br")])]),t("p",[a._v("安装完成后，有两个文件需要我们认识下，一个是 "),t("code",[a._v("/etc/keepalived/keepalived.conf")]),a._v("(keepalived的系统配置文件，我们主要操作的就是该文件)，一个是/usr/local/sbin目录下的"),t("code",[a._v("keepalived")]),a._v(",是系统配置脚本，用来启动和关闭keepalived")]),a._v(" "),t("h3",{attrs:{id:"keepalived配置文件介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#keepalived配置文件介绍"}},[a._v("#")]),a._v(" Keepalived配置文件介绍")]),a._v(" "),t("p",[a._v("打开keepalived.conf配置文件")]),a._v(" "),t("p",[a._v("这里面会分三部，第一部分是global全局配置、第二部分是vrrp相关配置、第三部分是LVS相关配置。\n本次课程主要是使用keepalived实现高可用部署，没有用到LVS，所以我们重点关注的是前两部分")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[a._v("global全局部分：\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("global_defs")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #通知邮件，当keepalived发送切换时需要发email给具体的邮箱地址")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   notification_email")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n     tom@itcast.cn\n     jerry@itcast.cn\n   }\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #设置发件人的邮箱信息")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   notification_email_from")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("zhaomin@itcast.cn")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #指定smpt服务地址")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   smtp_server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #指定smpt服务连接超时时间")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   smtp_connect_timeout")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("30")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #运行keepalived服务器的一个标识，可以用作发送邮件的主题信息")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   router_id")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("LVS_DEVEL")]),a._v("\n   \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)")]),a._v("\n   vrrp_skip_check_adv_addr\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #严格遵守VRRP协议。")]),a._v("\n   vrrp_strict\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #在一个接口发送的两个免费ARP之间的延迟。可以精确到毫秒级。默认是0")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   vrrp_garp_interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("   #在一个网卡上每组na消息之间的延迟时间，默认为0")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   vrrp_gna_interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0")]),a._v("\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br")])]),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[a._v("VRRP部分，该部分可以包含以下四个子模块\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("1.")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("vrrp_script")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("2.")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("vrrp_sync_group")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("3.")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("garp_group")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("4.")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("vrrp_instance")]),a._v("\n我们会用到第一个和第四个，\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#设置keepalived实例的相关信息，VI_1为VRRP实例名称")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("vrrp_instance")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("VI_1 {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    state")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("MASTER  \t\t#有两个值可选MASTER主 BACKUP备")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    interface")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ens33\t\t#vrrp实例绑定的接口，用于发送VRRP包[当前服务器使用的网卡名称]")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_router_id")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("51#指定VRRP实例ID，范围是0-255")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    priority")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("100\t\t#指定优先级，优先级高的将成为MASTER")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    advert_int")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1\t\t#指定发送VRRP通告的间隔，单位是秒")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    authentication")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{\t#vrrp之间通信的认证信息")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_type")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("PASS\t#指定认证方式。PASS简单密码认证(推荐)")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_pass")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1111\t#指定认证使用的密码，最多8位")]),a._v("\n    }\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_ipaddress")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{ #虚拟IP地址设置虚拟IP地址，供用户访问使用，可设置多个，一行一个")]),a._v("\n        192.168.200.222\n    }\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br")])]),t("p",[a._v("配置内容如下:")]),a._v(" "),t("p",[a._v("服务器1")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("global_defs")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   notification_email")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n        tom@itcast.cn\n        jerry@itcast.cn\n   }\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   notification_email_from")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("zhaomin@itcast.cn")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   smtp_server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   smtp_connect_timeout")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("30")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   router_id")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("keepalived1")]),a._v("\n   vrrp_skip_check_adv_addr\n   vrrp_strict\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   vrrp_garp_interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   vrrp_gna_interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0")]),a._v("\n}\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("vrrp_instance")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("VI_1 {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    state")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("MASTER")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    interface")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ens33")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_router_id")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("51")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    priority")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("100")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    advert_int")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    authentication")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_type")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("PASS")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_pass")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1111")]),a._v("\n    }\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_ipaddress")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n        192.168.200.222\n    }\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br"),t("span",{staticClass:"line-number"},[a._v("26")]),t("br"),t("span",{staticClass:"line-number"},[a._v("27")]),t("br"),t("span",{staticClass:"line-number"},[a._v("28")]),t("br"),t("span",{staticClass:"line-number"},[a._v("29")]),t("br")])]),t("p",[a._v("服务器2")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("! Configuration File for keepalived")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("global_defs")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   notification_email")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n        tom@itcast.cn\n        jerry@itcast.cn\n   }\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   notification_email_from")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("zhaomin@itcast.cn")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   smtp_server")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("192.168.200.1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   smtp_connect_timeout")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("30")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   router_id")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("keepalived2")]),a._v("\n   vrrp_skip_check_adv_addr\n   vrrp_strict\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   vrrp_garp_interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   vrrp_gna_interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("0")]),a._v("\n}\n\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("vrrp_instance")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("VI_1 {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    state")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("BACKUP")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    interface")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ens33")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_router_id")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("51")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    priority")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("90")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    advert_int")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    authentication")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_type")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("PASS")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_pass")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1111")]),a._v("\n    }\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_ipaddress")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n        192.168.200.222\n    }\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br"),t("span",{staticClass:"line-number"},[a._v("26")]),t("br"),t("span",{staticClass:"line-number"},[a._v("27")]),t("br"),t("span",{staticClass:"line-number"},[a._v("28")]),t("br"),t("span",{staticClass:"line-number"},[a._v("29")]),t("br"),t("span",{staticClass:"line-number"},[a._v("30")]),t("br"),t("span",{staticClass:"line-number"},[a._v("31")]),t("br")])]),t("h3",{attrs:{id:"访问测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问测试"}},[a._v("#")]),a._v(" 访问测试")]),a._v(" "),t("ol",[t("li",[a._v("启动keepalived之前，咱们先使用命令 "),t("code",[a._v("ip a")]),a._v(",查看192.168.200.133和192.168.200.122这两台服务器的IP情况。")])]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182041763.png",alt:"1604599529242"}})]),a._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[a._v("分别启动两台服务器的keepalived")])]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("cd")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("/usr/local/sbin")]),a._v("\n./keepalived\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("p",[a._v("再次通过 "),t("code",[a._v("ip a")]),a._v("查看ip")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182042945.png",alt:"1604599616821"}})]),a._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[a._v("当把192.168.200.133服务器上的keepalived关闭后，再次查看ip")])]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182042724.png",alt:"1604599709822"}})]),a._v(" "),t("p",[a._v('通过上述的测试，我们会发现，虚拟IP(VIP)会在MASTER节点上，当MASTER节点上的keepalived出问题以后，因为BACKUP无法收到MASTER发出的VRRP状态通过信息，就会直接升为MASTER。VIP也会"漂移"到新的MASTER。')]),a._v(" "),t("p",[a._v("上面测试和Nginx有什么关系?")]),a._v(" "),t("p",[a._v('我们把192.168.200.133服务器的keepalived再次启动下，由于它的优先级高于服务器192.168.200.122的，所有它会再次成为MASTER，VIP也会"漂移"过去，然后我们再次通过浏览器访问:')]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("//192.168.200.222/")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182042130.png",alt:"1604600079149"}})]),a._v(" "),t("p",[a._v("如果把192.168.200.133服务器的keepalived关闭掉，再次访问相同的地址")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202303182042043.png",alt:"1604600145318"}})]),a._v(" "),t("p",[a._v('效果实现了以后， 我们会发现要想让vip进行切换，就必须要把服务器上的keepalived进行关闭，而什么时候关闭keepalived呢?应该是在keepalived所在服务器的nginx出现问题后，把keepalived关闭掉，就可以让VIP执行另外一台服务器，但是现在这所有的操作都是通过手动来完成的，我们如何能让系统自动判断当前服务器的nginx是否正确启动，如果没有，要能让VIP自动进行"漂移"，这个问题该如何解决?')]),a._v(" "),t("h3",{attrs:{id:"keepalived之vrrp-script"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#keepalived之vrrp-script"}},[a._v("#")]),a._v(" keepalived之vrrp_script")]),a._v(" "),t("p",[a._v("keepalived只能做到对网络故障和keepalived本身的监控，即当出现网络故障或者keepalived本身出现问题时，进行切换。但是这些还不够，我们还需要监控keepalived所在服务器上的其他业务，比如Nginx,如果Nginx出现异常了，仅仅keepalived保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换，这个时候，我们可以通过编写脚本对业务进程进行检测监控。")]),a._v(" "),t("p",[a._v("实现步骤:")]),a._v(" "),t("ol",[t("li",[a._v("在keepalived配置文件中添加对应的配置像")])]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("vrrp_script")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("脚本名称")]),a._v("\n{\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    script")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v('"脚本位置"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("3 #执行时间间隔")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    weight")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("-20 #动态调整vrrp_instance的优先级")]),a._v("\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[a._v("编写脚本")])]),a._v(" "),t("p",[a._v("ck_nginx.sh")]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#!/bin/bash")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("num")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("`ps -C nginx --no-header | wc -l`")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("[ $num -eq 0 ];then")]),a._v("\n /usr/local/nginx/sbin/nginx\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" sleep")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("2")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v(" if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("[ `ps -C nginx --no-header | wc -l` -eq 0 ]; then")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("  killall")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("keepalived")]),a._v("\n fi\nfi\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br")])]),t("p",[a._v("Linux ps命令用于显示当前进程 (process) 的状态。")]),a._v(" "),t("p",[a._v("-C(command) :指定命令的所有进程")]),a._v(" "),t("p",[a._v("--no-header 排除标题")]),a._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[a._v("为脚本文件设置权限")])]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("chmod")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("755 ck_nginx.sh")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[a._v("将脚本添加到")])]),a._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("vrrp_script")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ck_nginx {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   script")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v('"/etc/keepalived/ck_nginx.sh" #执行脚本的位置')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   interval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("2\t\t#执行脚本的周期，秒为单位")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("   weight")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("-20\t\t#权重的计算方式")]),a._v("\n}\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("vrrp_instance")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("VI_1 {")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    state")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("MASTER")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    interface")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("ens33")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_router_id")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("10")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    priority")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("100")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    advert_int")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    authentication")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_type")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("PASS")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("        auth_pass")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1111")]),a._v("\n    }\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    virtual_ipaddress")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n        192.168.200.111\n    }\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("    track_script")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("{")]),a._v("\n      ck_nginx\n    }\n}\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br")])]),t("ol",{attrs:{start:"5"}},[t("li",[a._v("如果效果没有出来，可以使用 "),t("code",[a._v("tail -f /var/log/messages")]),a._v("查看日志信息，找对应的错误信息。")]),a._v(" "),t("li",[a._v("测试")])]),a._v(" "),t("p",[a._v("问题思考:")]),a._v(" "),t("p",[a._v("通常如果master服务死掉后backup会变成master，但是当master服务又好了的时候 master此时会抢占VIP，这样就会发生两次切换对业务繁忙的网站来说是不好的。所以我们要在配置文件加入 nopreempt 非抢占，但是这个参数只能用于state 为backup，故我们在用HA的时候最好master 和backup的state都设置成backup 让其通过priority来竞争。")])])}),[],!1,null,null,null);t.default=n.exports}}]);