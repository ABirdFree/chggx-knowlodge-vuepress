<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloud.H基础 | chggx-knowledge</title>
    <meta name="generator" content="VuePress 1.9.2">
    <link rel="icon" href="/chggx-knowlodge-vuepress/img/favicon.ico">
    <meta name="description" content="一个基于VuePress的 知识管理&amp;博客 主题">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/chggx-knowlodge-vuepress/assets/css/0.styles.2ef74c7b.css" as="style"><link rel="preload" href="/chggx-knowlodge-vuepress/assets/js/app.0b8929fd.js" as="script"><link rel="preload" href="/chggx-knowlodge-vuepress/assets/js/2.796b80a3.js" as="script"><link rel="preload" href="/chggx-knowlodge-vuepress/assets/js/90.7e973c3d.js" as="script"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/10.14778c29.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/100.90f1b044.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/101.4bfc3a79.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/102.309b1f1f.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/103.6615ef18.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/104.f59e8985.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/105.96f4b39f.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/106.8c24d114.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/107.086e4dd5.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/108.9130315c.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/11.cbcc54fd.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/12.2f225dd6.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/13.d2c62c63.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/14.7612e5bd.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/15.ab1fbd66.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/16.dcea142c.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/17.65118ab4.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/18.35ef0692.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/19.3465ec36.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/20.58da3cf5.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/21.a8106bc4.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/22.302ccd08.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/23.35f5fabc.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/24.6d1a4981.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/25.6c526606.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/26.37b92024.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/27.cb60f838.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/28.490f60cd.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/29.76810b5d.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/3.82d8f896.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/30.dc249013.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/31.4a8493eb.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/32.127bfa46.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/33.ea85c33c.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/34.268f84bf.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/35.fcb45264.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/36.7dacbdd6.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/37.6a98c436.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/38.73c67499.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/39.ac8a81b3.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/4.1abb0fb3.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/40.c32050b4.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/41.7a2d3e9a.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/42.abc8e666.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/43.2f8510af.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/44.7a2b625d.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/45.68e5089c.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/46.c5047f52.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/47.b8de861e.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/48.b6bcfbff.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/49.717e5eae.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/5.611bb8b1.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/50.58c15c01.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/51.9c8ba2a5.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/52.2222db4d.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/53.57168bca.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/54.58a21ec9.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/55.45adab2f.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/56.18e8a10c.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/57.8f626616.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/58.84b59f7c.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/59.f372e5ba.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/6.2526c666.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/60.a70654c7.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/61.e08974b7.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/62.22b6e96f.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/63.58f3fbdb.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/64.ba032506.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/65.895d78f1.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/66.57ece92f.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/67.a1b6ef42.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/68.8be3af09.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/69.31acda88.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/7.5a83f993.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/70.b0fd3d1f.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/71.bd8dc17e.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/72.084a57a6.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/73.b7bdc987.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/74.896fcc62.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/75.57a0545d.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/76.7c461d04.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/77.1d5ba5c3.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/78.403cef32.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/79.a28e6d63.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/8.ced0820d.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/80.045dc3d2.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/81.02547d23.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/82.e55048e2.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/83.5a21347a.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/84.1acf4a03.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/85.3b05b369.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/86.96adbf4b.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/87.742fa2c1.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/88.8bc28081.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/89.e9ba15af.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/9.c16e6e51.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/91.9dceb22b.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/92.9ab1179c.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/93.4a49d7eb.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/94.134c317d.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/95.4477b326.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/96.01c5edc5.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/97.3e65955d.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/98.7dc43bfa.js"><link rel="prefetch" href="/chggx-knowlodge-vuepress/assets/js/99.a1ff3b81.js">
    <link rel="stylesheet" href="/chggx-knowlodge-vuepress/assets/css/0.styles.2ef74c7b.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/chggx-knowlodge-vuepress/" class="home-link router-link-active"><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/202302271042851.png" alt="chggx-knowledge" class="logo"> <span class="site-name can-hide">chggx-knowledge</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/chggx-knowlodge-vuepress/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/ec1391/" class="link-title">语言</a> <span class="title" style="display:none;">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>JAVA语言</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/ec1391/" class="nav-link">语言基础</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/9faa36/" class="nav-link">JVM</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">并发&amp;多线程</a></li></ul></li><li class="dropdown-item"><h4>C语言</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/40db50/" class="nav-link">语言基础</a></li></ul></li><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/29740f/" class="nav-link">MySQL基础</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">MySQL高级</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/ff9a50/" class="nav-link">Influxdb</a></li></ul></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">三大件</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">基础库</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/febdf1/" class="link-title">编程基础</a> <span class="title" style="display:none;">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据结构和算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/febdf1/" class="nav-link">数据结构</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">算法</a></li></ul></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">操作系统</a></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/391852/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/6ad6ad/" class="link-title">开发工具</a> <span class="title" style="display:none;">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>集成开发环境</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/6ad6ad/" class="nav-link">IDEA</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/d486f7/" class="nav-link">VSCode</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/17afa5/" class="nav-link">数据库工具</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/5082de/" class="nav-link">接口测试工具</a></li></ul></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">Linux系统</a></li><li class="dropdown-item"><h4>代码管理工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/00b1bb/" class="nav-link">Svn</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/d486f7/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>项目管理&amp;构建工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/020d30/" class="nav-link">Maven</a></li></ul></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/e8fc76/" class="nav-link">代码质量检查</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="应用框架" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/0705f0/" class="link-title">应用框架</a> <span class="title" style="display:none;">应用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Spring家族</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/0705f0/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">SpringMVC</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/c71dea/" class="nav-link">SpringBoot</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/" aria-current="page" class="nav-link router-link-exact-active router-link-active">SpringCloud</a></li></ul></li><li class="dropdown-item"><h4>服务器软件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/9e3fdb/" class="nav-link">Web服务器</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/62479e/" class="nav-link">应用服务器</a></li></ul></li><li class="dropdown-item"><h4>中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/1db5d1/" class="nav-link">缓存</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/19fb99/" class="nav-link">消息队列</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">RPC架构</a></li></ul></li><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">ORM层框架</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">连接池</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">分库分表</a></li></ul></li><li class="dropdown-item"><h4>搜索引擎</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/6641bc/" class="nav-link">ElasticSearch</a></li></ul></li><li class="dropdown-item"><h4>模板框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">Thymeleaf</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">FreeMarker</a></li></ul></li><li class="dropdown-item"><h4>前端组件化框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/abd7cf/" class="nav-link">Node</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">VUE</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/chggx-knowlodge-vuepress/pages/b0e900/" class="nav-link">在线技术文档</a></div> <a href="https://github.com/ABirdFree" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/chggx-knowlodge-vuepress/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/ec1391/" class="link-title">语言</a> <span class="title" style="display:none;">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>JAVA语言</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/ec1391/" class="nav-link">语言基础</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/9faa36/" class="nav-link">JVM</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">并发&amp;多线程</a></li></ul></li><li class="dropdown-item"><h4>C语言</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/40db50/" class="nav-link">语言基础</a></li></ul></li><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/29740f/" class="nav-link">MySQL基础</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">MySQL高级</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/ff9a50/" class="nav-link">Influxdb</a></li></ul></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">三大件</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">基础库</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程基础" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/febdf1/" class="link-title">编程基础</a> <span class="title" style="display:none;">编程基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据结构和算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/febdf1/" class="nav-link">数据结构</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">算法</a></li></ul></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">操作系统</a></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/391852/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发工具" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/6ad6ad/" class="link-title">开发工具</a> <span class="title" style="display:none;">开发工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>集成开发环境</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/6ad6ad/" class="nav-link">IDEA</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/d486f7/" class="nav-link">VSCode</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/17afa5/" class="nav-link">数据库工具</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/5082de/" class="nav-link">接口测试工具</a></li></ul></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">Linux系统</a></li><li class="dropdown-item"><h4>代码管理工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/00b1bb/" class="nav-link">Svn</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/d486f7/" class="nav-link">Git</a></li></ul></li><li class="dropdown-item"><h4>项目管理&amp;构建工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/020d30/" class="nav-link">Maven</a></li></ul></li><li class="dropdown-item"><!----> <a href="/chggx-knowlodge-vuepress/pages/e8fc76/" class="nav-link">代码质量检查</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="应用框架" class="dropdown-title"><a href="/chggx-knowlodge-vuepress/pages/0705f0/" class="link-title">应用框架</a> <span class="title" style="display:none;">应用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Spring家族</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/0705f0/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">SpringMVC</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/c71dea/" class="nav-link">SpringBoot</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/" aria-current="page" class="nav-link router-link-exact-active router-link-active">SpringCloud</a></li></ul></li><li class="dropdown-item"><h4>服务器软件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/9e3fdb/" class="nav-link">Web服务器</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/62479e/" class="nav-link">应用服务器</a></li></ul></li><li class="dropdown-item"><h4>中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/1db5d1/" class="nav-link">缓存</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/19fb99/" class="nav-link">消息队列</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">RPC架构</a></li></ul></li><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">ORM层框架</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">连接池</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">分库分表</a></li></ul></li><li class="dropdown-item"><h4>搜索引擎</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/6641bc/" class="nav-link">ElasticSearch</a></li></ul></li><li class="dropdown-item"><h4>模板框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">Thymeleaf</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">FreeMarker</a></li></ul></li><li class="dropdown-item"><h4>前端组件化框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/abd7cf/" class="nav-link">Node</a></li><li class="dropdown-subitem"><a href="/chggx-knowlodge-vuepress/pages/" class="nav-link router-link-active">VUE</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/chggx-knowlodge-vuepress/pages/b0e900/" class="nav-link">在线技术文档</a></div> <a href="https://github.com/ABirdFree" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring家族</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>SpringMVC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>SpringBoot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>SpringCloud</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/chggx-knowlodge-vuepress/pages/0a5c18/" aria-current="page" class="active sidebar-link">SpringCloud.H基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-springboot2-x版和springcloud-h版" class="sidebar-link">1. SpringBoot2.X版和SpringCloud H版</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-springboot-2-0-之后" class="sidebar-link">1. SpringBoot 2.0 之后</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-springcloud" class="sidebar-link">2. SpringCloud</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-关于cloud组件的停更-升级-替换" class="sidebar-link">2.关于Cloud组件的停更/升级/替换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-停更前" class="sidebar-link">1. 停更前</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-注册中心" class="sidebar-link">2. 注册中心</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-eureka" class="sidebar-link">1. eureka</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-zookeeper" class="sidebar-link">2. zookeeper</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-consul" class="sidebar-link">3. consul</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-nacos-阿里" class="sidebar-link">4. Nacos (阿里)</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-服务的调用" class="sidebar-link">3. 服务的调用</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-rabbon" class="sidebar-link">1. rabbon</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-loadbalancer" class="sidebar-link">2. LoadBalancer</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-服务的调用2" class="sidebar-link">4. 服务的调用2</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-feign" class="sidebar-link">1. feign</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-openfeign" class="sidebar-link">2. OpenFeign</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-降级服务" class="sidebar-link">5. 降级服务</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-hystrix" class="sidebar-link">1. Hystrix</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-resilience4j" class="sidebar-link">2.  resilience4j</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-sentienl-阿里" class="sidebar-link">3. sentienl(阿里)</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_6-服务网关" class="sidebar-link">6. 服务网关</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-zuul" class="sidebar-link">1. zuul</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-gateway" class="sidebar-link">2. gateway</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_7-服务配置" class="sidebar-link">7.  服务配置</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-config" class="sidebar-link">1. Config</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-nocos" class="sidebar-link">2.  Nocos</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_8-服务总线" class="sidebar-link">8. 服务总线</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-bus" class="sidebar-link">1. Bus</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-nacos" class="sidebar-link">2. Nacos</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-微服务架构编码" class="sidebar-link">3. 微服务架构编码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-订单-支付模块微服务" class="sidebar-link">1. 订单-支付模块微服务</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-actuator微服务信息完善" class="sidebar-link">2. actuator微服务信息完善</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-主机名称-服务名称修改" class="sidebar-link">1. 主机名称：服务名称修改</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-当前问题" class="sidebar-link">1. 当前问题：</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-配置" class="sidebar-link">2. 配置</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-效果" class="sidebar-link">3. 效果</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-ip提示" class="sidebar-link">2. IP提示</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-配置" class="sidebar-link">1. 配置</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-效果" class="sidebar-link">2. 效果</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-服务发现discovery" class="sidebar-link">3. 服务发现Discovery</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-使用" class="sidebar-link">1. 使用</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-启动类" class="sidebar-link">1. 启动类</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-代码" class="sidebar-link">2. 代码</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-eureka自我保护理论知识" class="sidebar-link">4. Eureka自我保护理论知识</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述" class="sidebar-link">1. 概述：</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-解决" class="sidebar-link">2. 解决</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-eureka服务端" class="sidebar-link">1. eureka服务端</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-客户端" class="sidebar-link">2. 客户端</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-注册中心" class="sidebar-link">4. 注册中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-zookeeper" class="sidebar-link">1. zookeeper</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-2" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-入门" class="sidebar-link">2. 入门</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-依赖" class="sidebar-link">1.依赖</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-配置-2" class="sidebar-link">2.配置</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-代码" class="sidebar-link">3.代码</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-jar包冲突" class="sidebar-link">3. jar包冲突</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-zookeeper作为服务注册中心-微服务作为节点注册进来-那这个节点是临时还是持久" class="sidebar-link">4. zookeeper作为服务注册中心，微服务作为节点注册进来，那这个节点是临时还是持久？</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-consul" class="sidebar-link">2. consul</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-3" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-consul安装" class="sidebar-link">2. consul安装</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-下载" class="sidebar-link">1.下载</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-安装" class="sidebar-link">2. 安装</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-eureka-consul-zookeeper异同点" class="sidebar-link">3. eureka, consul, zookeeper异同点</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-异同点" class="sidebar-link">1. 异同点</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-cap核心理论" class="sidebar-link">2. CAP核心理论</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-eureka-2" class="sidebar-link">1. eureka</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-zookeeper-consul" class="sidebar-link">2. zookeeper/consul</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-负载均衡-服务调用" class="sidebar-link">4. 负载均衡[服务调用]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-rbbon" class="sidebar-link">1. Rbbon</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-4" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-作用-lb负载均衡-load-balance" class="sidebar-link">2. 作用： LB负载均衡（Load Balance）</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-集中式b" class="sidebar-link">1. 集中式B</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-进程内lb" class="sidebar-link">2. 进程内LB</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-ribbon-本地负载均衡客户端-和-nginx-服务端负载均衡-区别" class="sidebar-link">3. Ribbon 本地负载均衡客户端 和 Nginx 服务端负载均衡 区别：</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-架构" class="sidebar-link">3. 架构</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-ribbon核心组件irule" class="sidebar-link">4. ribbon核心组件IRule</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-ribbon-负载规则替换" class="sidebar-link">5. Ribbon 负载规则替换</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-添加规则类" class="sidebar-link">1 添加规则类：</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-自定义负载均衡规则类" class="sidebar-link">2.自定义负载均衡规则类</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_6-ribbon负载均衡算法" class="sidebar-link">6. ribbon负载均衡算法</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-原理" class="sidebar-link">1. 原理</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-源码" class="sidebar-link">2. 源码</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-irule" class="sidebar-link">1. IRule</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-roundrobinrule" class="sidebar-link">2.RoundRobinRule</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-手写一个负载均衡算法" class="sidebar-link">3. 手写一个负载均衡算法</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-改写提供者-2个" class="sidebar-link">1.改写提供者(2个)</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-消费者" class="sidebar-link">2. 消费者</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-服务调用" class="sidebar-link">5. 服务调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-openfeign" class="sidebar-link">1. openFeign</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-feign-简介" class="sidebar-link">1. Feign 简介：</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-feign-能干什么" class="sidebar-link">2 . Feign 能干什么？</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-feign集成了ribbon" class="sidebar-link">3. Feign集成了Ribbon</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-feign-和-openfeign-两者区别" class="sidebar-link">4. Feign 和 OpenFeign 两者区别</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-openfeign编码" class="sidebar-link">2. openFeign编码</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-openfeign超时控制" class="sidebar-link">3. openfeign超时控制</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-openfeign日志打印" class="sidebar-link">4. openfeign日志打印</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_6-服务降级" class="sidebar-link">6. 服务降级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-hystrix-2" class="sidebar-link">1. Hystrix</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-问题" class="sidebar-link">1. 问题</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-分布式系统面临的问题" class="sidebar-link">1. 分布式系统面临的问题</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-服务雪崩" class="sidebar-link">2. 服务雪崩：</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-hystrix-简介" class="sidebar-link">2. Hystrix 简介：</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-能干什么" class="sidebar-link">2. 能干什么?</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-hystrix-功能" class="sidebar-link">1. Hystrix 功能：</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-hystrix重要概念" class="sidebar-link">2. Hystrix重要概念：</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-服务降级-fallback" class="sidebar-link">1.服务降级：fallback</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#场景一" class="sidebar-link">场景一:</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#哪些情况会发出降级" class="sidebar-link">哪些情况会发出降级？</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-服务熔断-break" class="sidebar-link">2.服务熔断 break</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-服务限流-flowlimit" class="sidebar-link">3.服务限流 flowlimit</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-服务降级" class="sidebar-link">3. 服务降级 😄</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-降级容错解决的维度要求" class="sidebar-link">1.降级容错解决的维度要求</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-要求" class="sidebar-link">1. 要求</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-代码-2" class="sidebar-link">2. 代码:</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-优化代码" class="sidebar-link">2. 优化代码</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-问题-2" class="sidebar-link">1. 问题</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-解决-2" class="sidebar-link">2. 解决</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-解决1" class="sidebar-link">1.  解决1</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-解决2" class="sidebar-link">2. 解决2</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-服务熔断" class="sidebar-link">4.服务熔断 😄</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-服务的降级-进而熔断-恢复调用链路" class="sidebar-link">1.  服务的降级---&gt;进而熔断---&gt;恢复调用链路</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-结论" class="sidebar-link">2. 结论</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-熔断类型" class="sidebar-link">1. 熔断类型</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-断路器在什么情况下开始起作用" class="sidebar-link">2. 断路器在什么情况下开始起作用</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-断路器开启或关闭的条件" class="sidebar-link">3. 断路器开启或关闭的条件</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-断路器打开之后" class="sidebar-link">4. 断路器打开之后</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-hystrix相关配置" class="sidebar-link">3. Hystrix相关配置：</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-服务限流" class="sidebar-link">5. 服务限流</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_6-hystrix-图形化dashboard搭建及监控测试" class="sidebar-link">6. Hystrix 图形化Dashboard搭建及监控测试</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-5" class="sidebar-link">1 概述</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-编码" class="sidebar-link">2.编码</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-新版本hystrix需要在主启动类中指定监控路径" class="sidebar-link">3. 新版本Hystrix需要在主启动类中指定监控路径</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_7-网关" class="sidebar-link">7. 网关 😄</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-zuul-2" class="sidebar-link">1. Zuul</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-gateway-2" class="sidebar-link">2. gateway</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-6" class="sidebar-link">1.概述</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-介绍" class="sidebar-link">1. 介绍</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-能干什么-2" class="sidebar-link">2. 能干什么?</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-微服务架构中网关在哪里" class="sidebar-link">3. 微服务架构中网关在哪里?</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-为什么选择gateway" class="sidebar-link">4.  为什么选择Gateway</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-gateway-核心概念及工作流程" class="sidebar-link">2. Gateway 核心概念及工作流程</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-核心概念" class="sidebar-link">1. 核心概念</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-gateway工作流程" class="sidebar-link">2. gateway工作流程</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-编码" class="sidebar-link">3. 编码</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-gateway网关路由有两种配置方式" class="sidebar-link">4. Gateway网关路由有两种配置方式</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-方式一" class="sidebar-link">1. 方式一</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-方式二" class="sidebar-link">2. 方式二</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-动态路由" class="sidebar-link">5. 动态路由</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-为什么使用动态路由" class="sidebar-link">1. 为什么使用动态路由?</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-使用思路" class="sidebar-link">2. 使用思路</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-编码-2" class="sidebar-link">3. 编码</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_6-predicate" class="sidebar-link">6. Predicate</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_0-求时区时间" class="sidebar-link">0. 求时区时间</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-after-时间类型" class="sidebar-link">1. After</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-before-时间类型" class="sidebar-link">2. Before</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-between-时间类型" class="sidebar-link">3. Between</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-cookie" class="sidebar-link">4. Cookie</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-yml配置" class="sidebar-link">1.  yml配置</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-不带cookie-curl测试" class="sidebar-link">2. 不带cookie ==curl测试==</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-带cookie" class="sidebar-link">3. 带cookie</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-header" class="sidebar-link">5. Header</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-测试" class="sidebar-link">1.  测试</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_6-host" class="sidebar-link">6. Host</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_7-method" class="sidebar-link">7. Method</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_8-path" class="sidebar-link">8. Path</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_9-query" class="sidebar-link">9. Query</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_10-remoteaddr" class="sidebar-link">10. RemoteAddr</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_11-weight" class="sidebar-link">11. Weight</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_7-filter" class="sidebar-link">7. Filter</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-自定义接口" class="sidebar-link">1. 自定义接口</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-主要接口" class="sidebar-link">1. 主要接口</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-能干啥" class="sidebar-link">2. 能干啥?</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-编码-3" class="sidebar-link">3.  编码</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_8-分布式配置中心" class="sidebar-link">8. 分布式配置中心 😄</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-config-2" class="sidebar-link">1.  config</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-7" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-分布式系统面临的问题-配置问题" class="sidebar-link">1. 分布式系统面临的问题——配置问题</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-怎么玩" class="sidebar-link">2. 怎么玩?</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-能干嘛" class="sidebar-link">3. 能干嘛？</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-config-server与client配置与测试及动态刷新" class="sidebar-link">2. Config server与client配置与测试及动态刷新</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-编码" class="sidebar-link">1.  编码</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-配置读取规则" class="sidebar-link">2.配置读取规则</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-方式" class="sidebar-link">1.方式</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-label-application-profile-yml-推荐" class="sidebar-link">2.  /{label}/{application}-{profile}.yml</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-application-profile-yml" class="sidebar-link">3. /{application}-{profile}.yml</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-客户端配置" class="sidebar-link">3. 客户端配置</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-分布式-动态刷新问题" class="sidebar-link">4.  分布式==动态刷新问题==</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-问题-3" class="sidebar-link">1. 问题</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-解决-3" class="sidebar-link">2.解决</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_9-springcloud-bus消息总线" class="sidebar-link">9. SpringCloud Bus消息总线 😄</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-8" class="sidebar-link">1.概述</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-解决问题" class="sidebar-link">1 .解决问题</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-是什么-能干嘛" class="sidebar-link">2. 是什么? 能干嘛?</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-利用消息总线触发一个客户端-bus-refresh-而刷新所有客户端的配置" class="sidebar-link">1. 利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端的配置</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-利用消息总线触发一个服务端configserver的-bus-refresh端点-而刷新所有客户端的配置" class="sidebar-link">2.  利用消息总线触发一个服务端ConfigServer的/bus/refresh端点，而刷新所有客户端的配置</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-什么是总线" class="sidebar-link">3. 什么是总线？</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-基本原理" class="sidebar-link">4.  基本原理</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-rabbitmq配置" class="sidebar-link">2. RabbitMQ配置</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-springcloud-bus-动态刷新全局广播" class="sidebar-link">3. SpringCloud Bus==动态刷新全局广播==</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-配置-2" class="sidebar-link">1. 配置</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-设计思想" class="sidebar-link">2. 设计思想</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-利用消息总线触发一个客户端-bus-refresh-而刷新所有客户端的配置-2" class="sidebar-link">1. 利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端的配置</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-利用消息总线触发一个服务端configserver的-bus-refresh端点-而刷新所有客户端的配置-2" class="sidebar-link">2. 利用消息总线触发一个服务端ConfigServer的/bus/refresh端点，而刷新所有客户端的配置</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-springcloud-bus动态刷新-定点通知" class="sidebar-link">4.  SpringCloud Bus动态刷新==定点通知==</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-定点通知" class="sidebar-link">1. ==定点通知==</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-解决-4" class="sidebar-link">2. 解决：</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-案例" class="sidebar-link">3. 案例</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-bus总结" class="sidebar-link">5 bus总结</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_10-springcloud-stream消息驱动" class="sidebar-link">10. SpringCloud Stream消息驱动</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概述-9" class="sidebar-link">1. 概述</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-简介-官网" class="sidebar-link">1. 简介 官网</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-中文手册" class="sidebar-link">2. 中文手册：</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-设计思想及理念" class="sidebar-link">2.设计思想及理念</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-mq" class="sidebar-link">1 MQ</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-如何实现" class="sidebar-link">2. 如何实现?</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-流程" class="sidebar-link">3. 流程</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_4-案例-参考" class="sidebar-link">4. 案例 参考</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-生产者" class="sidebar-link">1. 生产者</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-消费者-2" class="sidebar-link">2. 消费者</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_5-分组消费与持久化" class="sidebar-link">5. 分组消费与持久化</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-分组消费" class="sidebar-link">1. 分组消费</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-问题-4" class="sidebar-link">1.  问题</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-分组" class="sidebar-link">2. 分组</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-原理-2" class="sidebar-link">1. 原理</a></li><li class="sidebar-sub-header level6"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-解决-5" class="sidebar-link">2. 解决</a></li><li class="sidebar-sub-header level5"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_3-总结" class="sidebar-link">3. 总结</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-持久化" class="sidebar-link">1. 持久化</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_11-springcloud-sleuth-分布式请求链路跟踪" class="sidebar-link">11. SpringCloud Sleuth 分布式请求链路跟踪</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-概念-官网" class="sidebar-link">1. 概念 官网</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-为什么出现-解决了" class="sidebar-link">1. 为什么出现? 解决了?</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-是什么" class="sidebar-link">2. 是什么?</a></li><li class="sidebar-sub-header level3"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-环境搭建" class="sidebar-link">2. 环境搭建</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_1-zipkin-下载地址" class="sidebar-link">1. zipkin 下载地址</a></li><li class="sidebar-sub-header level4"><a href="/chggx-knowlodge-vuepress/pages/0a5c18/#_2-服务搭建" class="sidebar-link">2. 服务搭建</a></li></ul></li></ul></li><li><a href="/chggx-knowlodge-vuepress/pages/f3ac37/" class="sidebar-link">SpringCloud Alibaba介绍</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务器软件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>搜索引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模板框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端组件化框架</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/chggx-knowlodge-vuepress/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>应用框架</span></li><li data-v-06225672><span data-v-06225672>Spring家族</span></li><li data-v-06225672><span data-v-06225672>SpringCloud</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/ABirdFree" target="_blank" title="作者" class="beLink" data-v-06225672>晨光-向</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-03-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">SpringCloud.H基础<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h1 id="springcloud-h基础"><a href="#springcloud-h基础" class="header-anchor">#</a> SpringCloud.H基础</h1> <h2 id="_1-springboot2-x版和springcloud-h版"><a href="#_1-springboot2-x版和springcloud-h版" class="header-anchor">#</a> 1. SpringBoot2.X版和SpringCloud H版</h2> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">版本选择</span> <span class="token value attr-value">2.2.2.RELEASE + Hoxton.SR1+ Meaven3.5及以上+MySQL5.7及以上+Java8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>版本选择 2.2.5.RELEASE + Hoxton.SR3</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">SpringBoot2.1.4版和SpringCloud</span> <span class="token value attr-value">G版</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1-springboot-2-0-之后"><a href="#_1-springboot-2-0-之后" class="header-anchor">#</a> 1. SpringBoot 2.0 之后</h3> <p>官网建议 2.0之后</p> <h3 id="_2-springcloud"><a href="#_2-springcloud" class="header-anchor">#</a> 2. SpringCloud</h3> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/springcloud%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E7%9A%84springboot%E7%89%88%E6%9C%AC.png?x-oss-process=style/shuiyin_1" alt=""></p> <hr> <h2 id="_2-关于cloud组件的停更-升级-替换"><a href="#_2-关于cloud组件的停更-升级-替换" class="header-anchor">#</a> 2.关于Cloud组件的停更/升级/替换</h2> <h3 id="_1-停更前"><a href="#_1-停更前" class="header-anchor">#</a> 1. 停更前</h3> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154503.png" alt=""></p> <hr> <h3 id="_2-注册中心"><a href="#_2-注册中心" class="header-anchor">#</a> 2. 注册中心</h3> <h4 id="_1-eureka"><a href="#_1-eureka" class="header-anchor">#</a> 1. eureka</h4> <p>停更</p> <h4 id="_2-zookeeper"><a href="#_2-zookeeper" class="header-anchor">#</a> 2. zookeeper</h4> <p>可以替换</p> <h4 id="_3-consul"><a href="#_3-consul" class="header-anchor">#</a> 3. consul</h4> <p>可以替换(GO语言写的)</p> <h4 id="_4-nacos-阿里"><a href="#_4-nacos-阿里" class="header-anchor">#</a> 4. Nacos (阿里)</h4> <hr> <h3 id="_3-服务的调用"><a href="#_3-服务的调用" class="header-anchor">#</a> 3. 服务的调用</h3> <h4 id="_1-rabbon"><a href="#_1-rabbon" class="header-anchor">#</a> 1. rabbon</h4> <p>还在使用</p> <h4 id="_2-loadbalancer"><a href="#_2-loadbalancer" class="header-anchor">#</a> 2. LoadBalancer</h4> <p>新的服务调用</p> <hr> <h3 id="_4-服务的调用2"><a href="#_4-服务的调用2" class="header-anchor">#</a> 4. 服务的调用2</h3> <h4 id="_1-feign"><a href="#_1-feign" class="header-anchor">#</a> 1. feign</h4> <p>挂了</p> <h4 id="_2-openfeign"><a href="#_2-openfeign" class="header-anchor">#</a> 2. OpenFeign</h4> <hr> <h3 id="_5-降级服务"><a href="#_5-降级服务" class="header-anchor">#</a> 5. 降级服务</h3> <h4 id="_1-hystrix"><a href="#_1-hystrix" class="header-anchor">#</a> 1. Hystrix</h4> <p>官网不用</p> <h4 id="_2-resilience4j"><a href="#_2-resilience4j" class="header-anchor">#</a> 2.  resilience4j</h4> <p>国外推荐</p> <h4 id="_3-sentienl-阿里"><a href="#_3-sentienl-阿里" class="header-anchor">#</a> 3. sentienl(阿里)</h4> <p>推荐</p> <hr> <h3 id="_6-服务网关"><a href="#_6-服务网关" class="header-anchor">#</a> 6. 服务网关</h3> <h4 id="_1-zuul"><a href="#_1-zuul" class="header-anchor">#</a> 1. zuul</h4> <p>挂了 (zuul死了)</p> <h4 id="_2-gateway"><a href="#_2-gateway" class="header-anchor">#</a> 2. gateway</h4> <p>推荐</p> <hr> <h3 id="_7-服务配置"><a href="#_7-服务配置" class="header-anchor">#</a> 7.  服务配置</h3> <h4 id="_1-config"><a href="#_1-config" class="header-anchor">#</a> 1. Config</h4> <p>不用</p> <h4 id="_2-nocos"><a href="#_2-nocos" class="header-anchor">#</a> 2.  Nocos</h4> <hr> <h3 id="_8-服务总线"><a href="#_8-服务总线" class="header-anchor">#</a> 8. 服务总线</h3> <h4 id="_1-bus"><a href="#_1-bus" class="header-anchor">#</a> 1. Bus</h4> <p>不用</p> <h4 id="_2-nacos"><a href="#_2-nacos" class="header-anchor">#</a> 2. Nacos</h4> <hr> <h2 id="_3-微服务架构编码"><a href="#_3-微服务架构编码" class="header-anchor">#</a> 3. 微服务架构编码</h2> <h3 id="_1-订单-支付模块微服务"><a href="#_1-订单-支付模块微服务" class="header-anchor">#</a> 1. <strong>订单-支付模块微服务</strong></h3> <p>https://blog.csdn.net/qq_41211642/article/details/104772140</p> <p>参考此博客</p> <hr> <h3 id="_2-actuator微服务信息完善"><a href="#_2-actuator微服务信息完善" class="header-anchor">#</a> 2. actuator微服务信息完善</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104802731</p> <h4 id="_1-主机名称-服务名称修改"><a href="#_1-主机名称-服务名称修改" class="header-anchor">#</a> 1. 主机名称：服务名称修改</h4> <h5 id="_1-当前问题"><a href="#_1-当前问题" class="header-anchor">#</a> 1. 当前问题：</h5> <p><code>服务注册含有主机名称，要想按照规范的要求，只暴露服务名，不要出现主机名</code></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154556.png" alt=""></p> <h5 id="_2-配置"><a href="#_2-配置" class="header-anchor">#</a> 2. 配置</h5> <p><strong>依赖</strong>标配</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>application.yml  eureka中添加</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>  <span class="token comment"># 主机名的修改</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> order80
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154613.png" alt=""></p> <h5 id="_3-效果"><a href="#_3-效果" class="header-anchor">#</a> 3. 效果</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154640.png" alt=""></p> <h4 id="_2-ip提示"><a href="#_2-ip提示" class="header-anchor">#</a> 2. IP提示</h4> <h5 id="_1-配置"><a href="#_1-配置" class="header-anchor">#</a> 1. 配置</h5> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 访问路径可以显示IP地址</span>
<span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154656.png" alt=""></p> <h5 id="_2-效果"><a href="#_2-效果" class="header-anchor">#</a> 2. 效果</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154707.png" alt=""></p> <hr> <h3 id="_3-服务发现discovery"><a href="#_3-服务发现discovery" class="header-anchor">#</a> 3. 服务发现Discovery</h3> <p><code>对于注册进入eureka里面的服务,可以通过服务发现来获取该服务信息</code></p> <p>https://blog.csdn.net/qq_41211642/article/details/104803913</p> <h4 id="_1-使用"><a href="#_1-使用" class="header-anchor">#</a> 1. 使用</h4> <h5 id="_1-启动类"><a href="#_1-启动类" class="header-anchor">#</a> 1. 启动类</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_2-代码"><a href="#_2-代码" class="header-anchor">#</a> 2. 代码</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/discovery&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. getServices 获取服务信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> services <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;服务信息: &quot;</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. serviceId: eureka对外暴露的服务实例, 如CLOUD-PAYMENT-SERVICE, CLOUD-ORDER-SERVER</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instances<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discoveryClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><hr> <h3 id="_4-eureka自我保护理论知识"><a href="#_4-eureka自我保护理论知识" class="header-anchor">#</a> 4. Eureka自我保护理论知识</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104804049</p> <h4 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1. 概述：</h4> <p>保护模式主要用于一组客户端和Eureka Server之间存在网络分区场景下的保护，一旦进入保护模式，Eureka Server将会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据，也就是不会注销任何微服务。
一句话： 某时刻某一个微服务不可用了，Eureka不会立刻清理，依旧会对该微服务的信息进行保存。</p> <p>如果在Eureka Server的首页看到以下这段提示，则说明Eureka进入了保护模式。属于CAP里面的AP分支。</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154722.png" alt=""></p> <h4 id="_2-解决"><a href="#_2-解决" class="header-anchor">#</a> 2. 解决</h4> <h5 id="_1-eureka服务端"><a href="#_1-eureka服务端" class="header-anchor">#</a> 1. eureka服务端</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154737.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154807.png" alt=""></p> <h5 id="_2-客户端"><a href="#_2-客户端" class="header-anchor">#</a> 2. 客户端</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154759.png" alt=""></p> <p>但客户端挂了后,eureka直接删除</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154819.png" alt=""></p> <p>宕机</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154827.png" alt=""></p> <hr> <h2 id="_4-注册中心"><a href="#_4-注册中心" class="header-anchor">#</a> 4. 注册中心</h2> <p>eureka停更.....</p> <p>使用:</p> <ul><li>Zookeeper</li> <li>consul</li> <li>Nacos(阿里)</li></ul> <h3 id="_1-zookeeper"><a href="#_1-zookeeper" class="header-anchor">#</a> 1. zookeeper</h3> <h4 id="_1-概述-2"><a href="#_1-概述-2" class="header-anchor">#</a> 1. 概述</h4> <p>zookeeper是一个分布式协调工具,可以实现注册中心功能</p> <p>https://blog.csdn.net/qq_41211642/article/details/104821619</p> <h4 id="_2-入门"><a href="#_2-入门" class="header-anchor">#</a> 2. 入门</h4> <h5 id="_1-依赖"><a href="#_1-依赖" class="header-anchor">#</a> 1.依赖</h5> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--springboot整合zookeeper客户端--&gt;</span>
<span class="token comment">&lt;!--替代eureka--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zookeeper-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="_2-配置-2"><a href="#_2-配置-2" class="header-anchor">#</a> 2.配置</h5> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment">#服务别名----注册zookeeper到注册中心名称</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment"># zookeeper配置</span>
    <span class="token key atrule">zookeeper</span><span class="token punctuation">:</span>
      <span class="token key atrule">connect-string</span><span class="token punctuation">:</span> 116.196.118.167<span class="token punctuation">:</span><span class="token number">2181</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="_3-代码"><a href="#_3-代码" class="header-anchor">#</a> 3.代码</h5> <p><code>@EnableDiscoveryClient</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @Author: CHGGX
 * @Date: 2020/03/30 14:25
 * @Description: &lt;h1&gt; Zookeeper作为服务器 &lt;/h1&gt;
 * @EnableDiscoveryClient // 该注解用户想使用consul或者zookeeper作为注册中心是服务注册
 */</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain8004</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain8004</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;payment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/zk&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentZk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;SpringCloud with Zookeeper: &quot;</span> <span class="token operator">+</span> serverPort <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_3-jar包冲突"><a href="#_3-jar包冲突" class="header-anchor">#</a> 3. jar包冲突</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zookeeper-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--先排除自带的zookeeper3.5.3--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--添加zookeeper3.5.6版本--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>PS：</strong> 新版本的zookeeper还会遇到slf4j和log4j包冲突的问题，此时在zookeeper去掉slf4j的依赖</p> <h4 id="_4-zookeeper作为服务注册中心-微服务作为节点注册进来-那这个节点是临时还是持久"><a href="#_4-zookeeper作为服务注册中心-微服务作为节点注册进来-那这个节点是临时还是持久" class="header-anchor">#</a> 4. zookeeper作为服务注册中心，微服务作为节点注册进来，那这个节点是临时还是持久？</h4> <p>关于Eureka我们知道，偶尔有一时刻服务提供者出了点故障，Eureka会开启自我保护机制，微服务不会被删除，那现在关闭8004试一下zookeeper中的服务会有什么变化吗</p> <ul><li>可以看出，Zookeeper也是在一定时间内，不会剔除服务，超时才剔除，所以zookeeper具备的<strong>服务节点是临时的</strong>。当你再启动8004时，zookeeper还会自动监听服务状态，但是流水号是一个新的流水号。</li></ul> <hr> <h3 id="_2-consul"><a href="#_2-consul" class="header-anchor">#</a> 2. consul</h3> <p>官网: https://www.consul.io/</p> <p>https://blog.csdn.net/qq_41211642/article/details/104828632</p> <h4 id="_1-概述-3"><a href="#_1-概述-3" class="header-anchor">#</a> 1. 概述</h4> <p>consul 是一台开源的分布式服务发现和配置管理系统,有HashiCorp公司用</p> <p><code>GO</code>语言开发</p> <p>提供了微服务系统中的服务之类,配置中心,控制总线....</p> <ul><li>可视化界面</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>peyment
  <span class="token comment">###consul注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token comment">#hostname: 127.0.0.1</span>
        <span class="token key atrule">service-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--springcloud consul-server--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_2-consul安装"><a href="#_2-consul安装" class="header-anchor">#</a> 2. consul安装</h4> <h5 id="_1-下载"><a href="#_1-下载" class="header-anchor">#</a> 1.下载</h5> <ul><li><p>官网下载地址： https://www.consul.io/downloads.html</p></li> <li><p>官网下载太慢，我找了一个百度云地址，提取码：247m
https://pan.baidu.com/s/1nMXRms3_ZPhgqawrcEcsdA</p></li></ul> <h5 id="_2-安装"><a href="#_2-安装" class="header-anchor">#</a> 2. 安装</h5> <p>下载完成后解压，根据自己实际情况选择路径</p> <ul><li>解压完成后，在解压路径下的地址栏输入“cmd”，打开命令行窗口。并键入“consul”，若出现一连串英文则表示安装成功，见图二。</li></ul> <p>启动：</p> <ul><li>命令<strong>consul agent -dev</strong>启动，看到Consul agent running! 启动成功</li></ul> <p>通过以下地址可以访问 Consul 首页
<code>http://localhost:8500</code></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154900.png" alt=""></p> <hr> <h3 id="_3-eureka-consul-zookeeper异同点"><a href="#_3-eureka-consul-zookeeper异同点" class="header-anchor">#</a> 3. eureka, consul, zookeeper异同点</h3> <h4 id="_1-异同点"><a href="#_1-异同点" class="header-anchor">#</a> 1. 异同点</h4> <table><thead><tr><th>组件名</th> <th>语言</th> <th>CAP</th> <th>服务健康可查</th> <th>对外暴露接口</th> <th style="text-align:left;">SpringCloud集成</th></tr></thead> <tbody><tr><td>Eureka</td> <td>Java</td> <td>AP</td> <td>可配支持</td> <td>HTTP</td> <td style="text-align:left;">已集成</td></tr> <tr><td>Consul</td> <td>Go</td> <td>CP</td> <td>支持</td> <td>HTTP/DNS</td> <td style="text-align:left;">已集成</td></tr> <tr><td>Zookeeper</td> <td>Java</td> <td>CP</td> <td>支持</td> <td>客户端</td> <td style="text-align:left;">已集成</td></tr></tbody></table> <p>PS: C: 强一致性,A: 可用性,P: 分区容错性</p> <h4 id="_2-cap核心理论"><a href="#_2-cap核心理论" class="header-anchor">#</a> 2. CAP核心理论</h4> <p>最多只能同时较好的满足两个</p> <p>CAP理论的核心是：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求。因此，根据CAP原理将NoSQL数据库分成了满足CA原则、满足CP原则和满足AP原则三大类。</p> <p>CA - 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强
CP - 满足一致性，分区容错性的系统，通常性能不是特别高
AP - 满足可用性，分区容错性的系统，通常可能对一致性要求低一些</p> <h5 id="_1-eureka-2"><a href="#_1-eureka-2" class="header-anchor">#</a> 1. eureka</h5> <ul><li>Eureka 采用的是<strong>AP架构</strong>，只满足可用性和分区容错性.</li> <li>当网络分区出现后，为了保证可用性，系统B可以返回旧值，保证系统的可用性。</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154943.png" alt=""></p> <ul><li>Eureka有自我保护机制，更强调的是AP，保证服务的高可用，微服务就是偶尔宕机掉线了，一时半会不会立刻删除。</li></ul> <h5 id="_2-zookeeper-consul"><a href="#_2-zookeeper-consul" class="header-anchor">#</a> 2. zookeeper/consul</h5> <ul><li>Zookeeper 和 Consul采用的是<strong>CP架构</strong>，满足一致性和分区容错性</li> <li>当网络分区出现后，为了保证一致性，就必须拒绝请求，否则无法保证一致性。</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223154955.png" alt=""></p> <p>PS: Zookeeper、Consul注册的微服务是一个<strong>临时节点</strong>，只要微服务不可用，发心跳测试收不到了，就迅速剔除微服务，微服务恢复过来以后，会重新换一个serviceID。</p> <hr> <h2 id="_4-负载均衡-服务调用"><a href="#_4-负载均衡-服务调用" class="header-anchor">#</a> 4. 负载均衡[服务调用]</h2> <h3 id="_1-rbbon"><a href="#_1-rbbon" class="header-anchor">#</a> 1. Rbbon</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104838727</p> <h4 id="_1-概述-4"><a href="#_1-概述-4" class="header-anchor">#</a> 1. 概述</h4> <p>Ribbon 简介：</p> <p>Spring Cloud Ribbon 是基于Netflix Ribbon 实现的一套客户端 <strong>负载均衡</strong>的工具。</p> <p>Ribbon 是 Netflix 发布的开源项目，主要功能是提供客户端的软件负载均衡算法和服务调用。Ribbon 客户端组件提供一系列完善的配置项如连接超时，重试等。简单的说，就是在配置文件中列出 Load Balancer（简称LB）后面所有的机器，Ribbon 会自动的帮助你基于某种规则（如简单轮询、随机连接等）去连接这些机器。我们很容易使用Ribbon实现自定义的负载均衡算法。</p> <p>官网资料：https://github.com/Netflix/ribbon/wiki/Getting-starte27</p> <p><strong>PS：</strong> Ribbon目前也进入维护模式，SpringCloud 想用Spring Cloud LoadBalancer 替代 Netflix 的Ribbon ，但现在 Ribbon 在生产环境中大规模部署，一时半会替不掉</p> <h4 id="_2-作用-lb负载均衡-load-balance"><a href="#_2-作用-lb负载均衡-load-balance" class="header-anchor">#</a> 2. 作用： LB负载均衡（Load Balance）</h4> <p>简单的说就是将用户的请求平摊的分配到多个服务上，从而达到系统的HA（高可用）。常见的负载均衡有软件 Nginx，LVS，硬件F5 等。</p> <h5 id="_1-集中式b"><a href="#_1-集中式b" class="header-anchor">#</a> 1. 集中式B</h5> <p>即在服务的消费方和提供方之间使用<strong>独立的LB设施</strong>（可以是硬件，如F5，也可以是软件，如nginx）,由该设施负责把访问请求通过某种策略转发至服务的提供方</p> <h5 id="_2-进程内lb"><a href="#_2-进程内lb" class="header-anchor">#</a> 2. 进程内LB</h5> <p>将 LB <strong>逻辑集成到消费方</strong>，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个合适的服务器。Ribbon就属于进程内 LB ，它只是一个类库，集成与消费方进程，消费方通过它来获取到服务提供方的地址。</p> <h5 id="_3-ribbon-本地负载均衡客户端-和-nginx-服务端负载均衡-区别"><a href="#_3-ribbon-本地负载均衡客户端-和-nginx-服务端负载均衡-区别" class="header-anchor">#</a> 3. Ribbon 本地负载均衡客户端 和 Nginx 服务端负载均衡 区别：</h5> <ul><li><p>Nginx 是服务器负载均衡，客户端所有请求都会交给 nginx ，然后由 nginx 实现转发请求。即负载均衡是由服务端实现的。</p></li> <li><p>Ribbon 本地负载均衡，在调用微服务接口时候，会在注册中心上获取注册信息服务列表之后缓存到JVM本地，从而在本地实现 RPC 远程服务调用技术。</p></li></ul> <p>总之一句话： <strong>Ribbon 就是 负载均衡 + RestTemplate调用，最终实现RPC的远程调用</strong></p> <h4 id="_3-架构"><a href="#_3-架构" class="header-anchor">#</a> 3. 架构</h4> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code>Ribbon：
<span class="token key attr-name">Ribbon</span> <span class="token value attr-value">是一个软负载均衡的客户端组件，它可以和其他所需请求的客户端结合使用，和 eureka 结合只是其中的一个实例。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155008.png" alt=""></p> <p><strong>Ribbon 在工作时分成两步：</strong></p> <ul><li>第一步先选择 EurekaServer，它优先选择在同一个区域内负载较少的server</li> <li>第二步再根据用户指定的策略，在从server 取到的服务注册列表中选择一个地址</li></ul> <p>其中Ribbon 提供了多种策略：比如<strong>轮询</strong>、<strong>随机</strong>和根据响应时间加权</p> <p>新版eureka引入了ribbon，所以不用自己引入也可以使用负载均衡</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155016.png" alt=""></p> <p><strong>RestTemplate使用：</strong></p> <p>官网：https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadoc-api/org/springframework/web/client/RestTemplate.html</p> <p>getForObject 方法 / getForEntity方法</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155027.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155037.png" alt=""></p> <p><strong>示例 ** getForObject 方法 / getForEntity方法 推荐</strong>getForObject** 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/create&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span><span class="token constant">PAYMENT_URL</span> <span class="token operator">+</span> <span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">,</span> payment<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/create2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">create2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommonResult</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForEntity</span><span class="token punctuation">(</span><span class="token constant">PAYMENT_URL</span> <span class="token operator">+</span> <span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">,</span> payment<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is2xxSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> entity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4444</span><span class="token punctuation">,</span><span class="token string">&quot;操作失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/get/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token constant">PAYMENT_URL</span> <span class="token operator">+</span> <span class="token string">&quot;/payment/get/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/getForEntity/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">getPayment2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommonResult</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token constant">PAYMENT_URL</span> <span class="token operator">+</span> <span class="token string">&quot;/payment/get/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is2xxSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> entity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4444</span><span class="token punctuation">,</span><span class="token string">&quot;操作失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="_4-ribbon核心组件irule"><a href="#_4-ribbon核心组件irule" class="header-anchor">#</a> 4. ribbon核心组件IRule</h4> <p>IRule: <code>根据特定算法从服务列表中选取一个要访问的服务</code></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155050.png" alt=""></p> <ul><li>com.netflix.loadbalancer.<strong>RoundRobinRule</strong> 轮询</li> <li>com.netflix.loadbalancer.<strong>RandomRule</strong> 随机</li> <li>com.netflix.loadbalancer.<strong>RetryRule</strong> 先按照RoundRobinRule的策略获取服务，如果获取服务失败则在指定时间内会进行重试，获取可用的服务</li> <li>WeightedResponseTimeRule 对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择</li> <li>BestAvailableRule 会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</li> <li>AvailabilityFilteringRule 先过滤掉故障实例，再选择并发较小的实例
ZoneAvoidanceRule 默认规则，复合判断server所在区域的性能和server的可用性选择服务器</li></ul> <h4 id="_5-ribbon-负载规则替换"><a href="#_5-ribbon-负载规则替换" class="header-anchor">#</a> 5. Ribbon 负载规则替换</h4> <h5 id="_1-添加规则类"><a href="#_1-添加规则类" class="header-anchor">#</a> 1 添加规则类：</h5> <p><strong>注意：</strong> 官方文档明确给出了警告：</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155101.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/ribbon%E8%A7%84%E5%88%99%E6%9B%BF%E6%8D%A2%E8%AD%A6%E5%91%8A2.png?x-oss-process=style/shuiyin_1" alt=""></p> <p>解决警告</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155108.png" alt=""></p> <h5 id="_2-自定义负载均衡规则类"><a href="#_2-自定义负载均衡规则类" class="header-anchor">#</a> 2.<em>自定义负载均衡规则类</em></h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySelfRule</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">myRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 随机</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RandomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155119.png" alt=""></p> <h4 id="_6-ribbon负载均衡算法"><a href="#_6-ribbon负载均衡算法" class="header-anchor">#</a> 6. ribbon负载均衡算法</h4> <h5 id="_1-原理"><a href="#_1-原理" class="header-anchor">#</a> 1. 原理</h5> <p><strong>轮询</strong>算法</p> <p><code>rest 接口第几次请求数 % 服务器集群总数量 = 实际调用服务器位置下标</code> <code>每次服务器重启后rest接口数从1开始</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(&quot;CLOUD-PROVIDER-SERVICE&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如：</p> <ul><li>List[0] instances = 127.0.0.1:8002</li> <li>List[1] instances = 127.0.0.1:8001</li></ul> <p>8001 + 8002 组合成为集群，它们共计2台机器，集群总数为2，按照轮询算法原理：</p> <table><thead><tr><th style="text-align:center;"><strong>总请求数</strong></th> <th style="text-align:center;"><strong>对应下标</strong></th> <th style="text-align:center;"><strong>获得服务器地址</strong></th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">1 % 2 = 1</td> <td style="text-align:center;">127.0.0.1:8001</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">2 %2 = 0</td> <td style="text-align:center;">127.0.0.1:8002</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">3 % 2 = 1</td> <td style="text-align:center;">127.0.0.1:8001</td></tr> <tr><td style="text-align:center;">4</td> <td style="text-align:center;">4 % 2 = 0</td> <td style="text-align:center;">127.0.0.1:8002</td></tr> <tr><td style="text-align:center;">...</td> <td style="text-align:center;">...</td> <td style="text-align:center;"></td></tr></tbody></table> <h5 id="_2-源码"><a href="#_2-源码" class="header-anchor">#</a> 2. 源码</h5> <h6 id="_1-irule"><a href="#_1-irule" class="header-anchor">#</a> 1. IRule</h6> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/*
*
* Copyright 2013 Netflix, Inc.
*
* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*
*/</span>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Interface that defines a &quot;Rule&quot; for a LoadBalancer. A Rule can be thought of
 * as a Strategy for loadbalacing. Well known loadbalancing strategies include
 * Round Robin, Response Time based etc.
 * 
 * @author stonse
 * 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRule</span><span class="token punctuation">{</span>
    <span class="token comment">/*
     * choose one alive server from lb.allServers or
     * lb.upServers according to key
     * 
     * @return choosen Server object. NULL is returned if none
     *  server is available 
     */</span>

    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ILoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h6 id="_2-roundrobinrule"><a href="#_2-roundrobinrule" class="header-anchor">#</a> 2.RoundRobinRule</h6> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/*
 *
 * Copyright 2013 Netflix, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */</span>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">IClientConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The most well known and basic load balancing strategy, i.e. Round Robin Rule.
 *
 * @author stonse
 * @author Nikos Michalakis &lt;nikos@netflix.com&gt;
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoundRobinRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> nextServerCyclicCounter<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">AVAILABLE_ONLY_SERVERS</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">ALL_SERVERS</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">RoundRobinRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextServerCyclicCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RoundRobinRule</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;no load balancer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> count<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> reachableServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allServers <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> upCount <span class="token operator">=</span> reachableServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>upCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No up servers available from load balancer: &quot;</span> <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> nextServerIndex <span class="token operator">=</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server <span class="token operator">=</span> allServers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextServerIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* Transient. */</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isReadyToServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Next.</span>
            server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span>
                    <span class="token operator">+</span> lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Inspired by the implementation of {@link AtomicInteger#incrementAndGet()}.
     *
     * @param modulo The modulo to bound the value of the counter.
     * @return The next value.
     * 自旋锁
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span><span class="token keyword">int</span> modulo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> current <span class="token operator">=</span> nextServerCyclicCounter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> modulo<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextServerCyclicCounter<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br></div></div><h5 id="_3-手写一个负载均衡算法"><a href="#_3-手写一个负载均衡算法" class="header-anchor">#</a> 3. 手写一个负载均衡算法</h5> <p>原理+JUC(CAS+自旋锁复习)</p> <h6 id="_1-改写提供者-2个"><a href="#_1-改写提供者-2个" class="header-anchor">#</a> 1.改写提供者(2个)</h6> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/lb&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">gePaymentLb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> serverPost<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h6 id="_2-消费者"><a href="#_2-消费者" class="header-anchor">#</a> 2. 消费者</h6> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
<span class="token comment">//    @LoadBalanced 注释掉</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> loadBalancer <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 获取示例
     *
     * @param serviceInstances 服务进程信息
     * @return 信息
     */</span>
    <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>实现类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @Author: CHGGX
 * @Date: 2020/03/30 20:07
 * @Description: &lt;h1&gt; 自定义ribbon轮询算法 &lt;/h1&gt;
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLb</span> <span class="token keyword">implements</span> loadBalancer <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> current<span class="token punctuation">;</span>
        <span class="token keyword">int</span> next<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            next <span class="token operator">=</span> current <span class="token operator">&gt;=</span> <span class="token number">2147483647</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;*****第几次访问,次数next: &quot;</span> <span class="token operator">+</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// `rest 接口第几次请求数 % 服务器集群总数量 = 实际调用服务器位置下标`</span>
        <span class="token comment">//`每次服务器重启后rest接口数从1开始`</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> serviceInstances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serviceInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2147483647</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>5controller</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> loadBalancer loadBalancer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用自定义的轮询算法,
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/lb&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPaymentLb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instances<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 使用自定义</span>
    <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancer<span class="token punctuation">.</span><span class="token function">instances</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">URI</span> uri <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>uri<span class="token operator">+</span><span class="token string">&quot;/payment/lb&quot;</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><hr> <h2 id="_5-服务调用"><a href="#_5-服务调用" class="header-anchor">#</a> 5. 服务调用</h2> <p>feign: 停更</p> <p>https://blog.csdn.net/qq_41211642/article/details/104846752</p> <h3 id="_1-openfeign"><a href="#_1-openfeign" class="header-anchor">#</a> 1. openFeign</h3> <p>官网：https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/#spring-cloud-openfeign</p> <h4 id="_1-feign-简介"><a href="#_1-feign-简介" class="header-anchor">#</a> 1. Feign 简介：</h4> <p>Feign 是一个声明式 WebService 客户端。使用 Feign 能让编写Web Service 客户端更加简单。</p> <p>它的使用方法是定义一个服务接口然后在上面添加注解。Feign 也支持可插拔式的编码器和解码器。Spring Cloud 对 Feign 进行了封装，使其支持了Spring MVC标准注解和 HttpMessageConverters。Feign 可以与 Eureka和Ribbon 组合使用以支持负载均衡。</p> <p>Github：https://github.com/spring-cloud/spring-cloud-openfeign</p> <h4 id="_2-feign-能干什么"><a href="#_2-feign-能干什么" class="header-anchor">#</a> 2 . Feign 能干什么？</h4> <p>Feign 旨在使编写Java Http 客户端变得更容易。
前面在使用 <strong>Ribbon+RestTemplate</strong>时，利用RestTemplate 对http请求的封装处理，形成了一套模板化的调用方法。但是在实际开发中，由于对服务依赖的调用可能不止一处，往往一个接口会被多处调用，所以通常都会针对每个微服务自行封装一些客户端类来包装这些依赖服务的调用。所以，Feign 在此基础上做了进一步封装，由他来帮助我们定义和实现依赖服务接口的定义。在Feign 的实现下，我们只需创建一个接口并使用注解的方式来配置它（以前是Dao接口上面标注Mapper注解，现在是一个微服务接口上面标注衣一个Feign注解即可），即可完成对服务提供方的接口绑定，简化了使用Spring Cloud Ribbon时，自动封装服务调用客户端的开发量。</p> <h4 id="_3-feign集成了ribbon"><a href="#_3-feign集成了ribbon" class="header-anchor">#</a> 3. Feign集成了Ribbon</h4> <p>利用Ribbon维护了Payment 的服务列表信息，并且通过轮询实现了客户端的负载均衡。而与Ribbon不同的是，通过feign 只需要定义服务绑定接口且以声明式的方法，优雅而简单的实现了服务调用。</p> <h4 id="_4-feign-和-openfeign-两者区别"><a href="#_4-feign-和-openfeign-两者区别" class="header-anchor">#</a> 4. Feign 和 OpenFeign 两者区别</h4> <p>Feign是Springcloud组件中的一个轻量级Restful的HTTP服务客户端，Feign内置了Ribbon，用来做客户端负载均衡，去调用服务注册中心的服务。Feign的使用方式是：使用Feign的注解定义接口，调用这个接口，就可以调用服务注册中心的服务</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>OpenFeign是springcloud在Feign的基础上支持了SpringMVC的注解，如@RequestMapping等等。OpenFeign的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-openfeign编码"><a href="#_2-openfeign编码" class="header-anchor">#</a> 2. openFeign编码</h3> <p><code>@EnableFeignClients</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/payment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentFeignService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 根据id获取payment
     *
     * @param id id
     * @return payment
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_3-openfeign超时控制"><a href="#_3-openfeign超时控制" class="header-anchor">#</a> 3. openfeign超时控制</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104850857</p> <p>解决:</p> <p>openFeign 内与 ribbon 整合了，支持负载均衡，它的超时控制也由最底层的 ribbon 进行控制，yml 添加配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment">#设置feign 客户端超时时间（openFeign默认支持ribbon）</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
<span class="token comment">#指的是建立连接所用的时间，适用于网络状况正常的情况下，两端连接所用的时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token comment">#指的是建立连接后从服务器读取到可用资源所用的时间</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_4-openfeign日志打印"><a href="#_4-openfeign日志打印" class="header-anchor">#</a> 4. openfeign日志打印</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104851537</p> <p><strong>日志级别：</strong></p> <ul><li>NONE：默认的，不显示任何日志</li> <li>BASIC：仅记录请求方法、URL、响应状态码及执行时间</li> <li>HEADERS：除了 BASIC 中定义的信息之外，还有请求和响应的头信息</li> <li>FULL：除了 HEADERS 中定义的信息之外，还有请求和响应的正文及元数据</li></ul> <p><strong>添加配置日志Bean</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">FULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>yml 配置开启日志的Feign客户端</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token comment">#feign日志以什么级别监控哪个接口</span>
    <span class="token key atrule">com.chggx.springboot.service.PaymentFeignService</span><span class="token punctuation">:</span> debug
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><hr> <h2 id="_6-服务降级"><a href="#_6-服务降级" class="header-anchor">#</a> 6. 服务降级</h2> <h3 id="_1-hystrix-2"><a href="#_1-hystrix-2" class="header-anchor">#</a> 1. Hystrix</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104851945</p> <h4 id="_1-问题"><a href="#_1-问题" class="header-anchor">#</a> 1. 问题</h4> <h5 id="_1-分布式系统面临的问题"><a href="#_1-分布式系统面临的问题" class="header-anchor">#</a> 1. 分布式系统面临的问题</h5> <p>复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某个时候将不可避免的失败。</p> <h5 id="_2-服务雪崩"><a href="#_2-服务雪崩" class="header-anchor">#</a> 2. 服务雪崩：</h5> <p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他的微服务，这就是所谓的 “ 扇出 ” 。
如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A 的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的 “ 雪崩效应 ”。</p> <p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。</p> <p>所以，通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接受流量，然后这个有问题的模块还调用了其他的模块，这样就会发生级联故障，或者叫 雪崩。</p> <p>要避免这样的级联故障，就需要有一种链路中断的方案：
<strong>服务降级</strong>、<strong>服务熔断</strong></p> <h4 id="_2-hystrix-简介"><a href="#_2-hystrix-简介" class="header-anchor">#</a> 2. Hystrix 简介：</h4> <p>Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，已提高分布式系统的弹性。</p> <p>“ 断路器 ” 本身是一种开关装置，当某个服务单元发送故障之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p> <ul><li><p>官网: https://github.com/Netflix/Hystrix/wiki/How-To-Use</p></li> <li><p>Hystrix 官宣：停更进入维护阶段</p></li> <li><p>spring推荐使用 <strong>resilience4j</strong> 替代，但是国内用的比较少，后续会介绍 <strong>SpringCloud Alibaba Sentinel</strong> 实现熔断和断流。</p></li></ul> <h3 id="_2-能干什么"><a href="#_2-能干什么" class="header-anchor">#</a> 2. 能干什么?</h3> <h4 id="_1-hystrix-功能"><a href="#_1-hystrix-功能" class="header-anchor">#</a> 1. Hystrix 功能：</h4> <ul><li><p>服务降级: fallback</p></li> <li><p>服务熔断: break</p></li> <li><p>接近实时的监控</p></li> <li><p>限流、隔离等: flowlimit</p></li></ul> <h4 id="_2-hystrix重要概念"><a href="#_2-hystrix重要概念" class="header-anchor">#</a> 2. Hystrix重要概念：</h4> <h5 id="_1-服务降级-fallback"><a href="#_1-服务降级-fallback" class="header-anchor">#</a> **1.服务降级：**fallback</h5> <h6 id="场景一"><a href="#场景一" class="header-anchor">#</a> 场景一:</h6> <p><code>服务器忙，请稍后再试，不让客户端等待并立刻返回一个友好提示.fallback</code></p> <p>打电话出现对方正在通话,请稍后再播.</p> <h6 id="哪些情况会发出降级"><a href="#哪些情况会发出降级" class="header-anchor">#</a> 哪些情况会发出降级？</h6> <ul><li>程序运行异常</li> <li>超时</li> <li>服务熔断触发服务降级</li> <li>线程池 / 信号量打满也会导致服务降级</li></ul> <h5 id="_2-服务熔断-break"><a href="#_2-服务熔断-break" class="header-anchor">#</a> <strong>2.服务熔断</strong> break</h5> <p>类似保险丝达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级的方法并返回友好提示</p> <h5 id="_3-服务限流-flowlimit"><a href="#_3-服务限流-flowlimit" class="header-anchor">#</a> <strong>3.服务限流</strong> flowlimit</h5> <p>秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行</p> <h3 id="_3-服务降级"><a href="#_3-服务降级" class="header-anchor">#</a> 3. 服务降级 😄</h3> <h4 id="_1-降级容错解决的维度要求"><a href="#_1-降级容错解决的维度要求" class="header-anchor">#</a> 1.降级容错解决的维度要求</h4> <h5 id="_1-要求"><a href="#_1-要求" class="header-anchor">#</a> 1. 要求</h5> <ol><li><p>超时导致服务器变慢 (转圈)</p> <ul><li>超时不再等待</li></ul></li> <li><p>出错（宕机或程序运行出错）</p> <ul><li>出错要有兜底</li></ul></li> <li><p>解决</p> <ul><li><p>对方服务(8001)超时了，调用者(80)不能一直卡死等待，必须有服务降级</p></li> <li><p>对方服务(8001)宕机了，调用者(80)不能一直卡死等待，必须有服务降级</p></li> <li><p>对方服务(8001)OK，调用者(80)自己出故障或有自我要求(自己的等待时间小于服务提供者)，自己处理降级</p></li></ul></li></ol> <h5 id="_2-代码-2"><a href="#_2-代码-2" class="header-anchor">#</a> 2. 代码:</h5> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--hystrix 熔断限流--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol><li>服务端</li></ol> <p>https://blog.csdn.net/qq_41211642/article/details/104859026</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 查实访问,TimeOut
 * * @HystrixCommand报异常后如何处理：
 * 1. 一旦调用服务方法失败并抛出了错误信息后，
 * 2. 会自动调用@HystrixCommand标注好的fallbackMethod调用类中的指定方法
 *
 * @param id id
 * @return String
 */</span>
<span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentInfo_TimeOutHandler&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">//设置这个线程的超时时间是3s，3s内是正常的业务逻辑，超过3s调用fallbackMethod指定的方法进行处理</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;3000&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> timeNumber <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment">// int age = 10/0'</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;线程池: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; paymentInfo_TimeOut,id: &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;O(∩_∩)O哈哈~&quot;</span> <span class="token operator">+</span> <span class="token string">&quot; 耗时(秒)&quot;</span> <span class="token operator">+</span> timeNumber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 出错要有兜底: 兜底方法
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOutHandler</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;线程池: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;系统繁忙,请稍后再试,id: &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>启动类添加</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableCircuitBreaker</span><span class="token operator">:</span> <span class="token comment">// 回路</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>客户端(推荐)</li></ol> <ul><li>配置文件</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 开启hystrix</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>启动类</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableHystrix</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>controller</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentTimeOutFallbackMethod&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">//设置这个线程的超时时间是3s，3s内是正常的业务逻辑，超过3s调用fallbackMethod指定的方法进行处理</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;1500&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>  paymentHystrixService<span class="token punctuation">.</span><span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 出错要有兜底: 兜底方法
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentTimeOutFallbackMethod</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;我是消费者80,对方支付系统繁忙请10秒钟后再试或者自己运行处处,请检查自己,o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>PS: 我们自己配置过的热部署方式对Java代码的改动明显，但对@HystrixCommand内属性的修改建议重启微服务。</p> <h4 id="_2-优化代码"><a href="#_2-优化代码" class="header-anchor">#</a> 2. 优化代码</h4> <h5 id="_1-问题-2"><a href="#_1-问题-2" class="header-anchor">#</a> 1. 问题</h5> <ul><li><strong>问题1:</strong></li></ul> <p>这样如果每个业务方法都对应一个兜底的方法，100个方法就有100个服务降级，会出现代码膨胀问题，我们需要一个统一的 fallbackMethod，统一的和自定义的分开。</p> <ul><li><strong>问题2：</strong></li></ul> <p>现在客户端与服务端关系紧紧耦合，客户端能跑是因为接口调用了微服务的业务逻辑方法，我们如果针对客户端接口做一些处理，把它调用的所有微服务方法进行降级，就可以解决耦合问题。</p> <h5 id="_2-解决-2"><a href="#_2-解决-2" class="header-anchor">#</a> 2. 解决</h5> <h6 id="_1-解决1"><a href="#_1-解决1" class="header-anchor">#</a> 1.  解决1</h6> <p>@DefaultProperties(defaultFallback = &quot;&quot;)</p> <p>1 : 1 每个方法配置一个服务降级方法，造成代码膨胀</p> <p>1 : N 除了个别重要核心业务有专属，其他普通的可以通过@DefaultProperties(defaultFallback = “”) 统一跳转到统一处理结果页面</p> <p>这样<strong>通用的和独享的各自分开，避免了代码膨胀，合理减少了代码量。</strong></p> <p><strong>步骤:</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 下面是全局fallback方法,
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Global异常处理信息,请稍后再试.o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>类上添加</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">&quot;payment_Global_FallbackMethod&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>添加降级注解</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@HystrixCommand</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>PS: 如果有自己的,使用自己的</p> <h6 id="_2-解决2"><a href="#_2-解决2" class="header-anchor">#</a> 2. 解决2</h6> <ul><li>对接口使用 @FeignClient(fallback = xxx.class) ------&gt;fallback = PaymentFallbackService.class</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">PaymentFallbackService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hystrix/ok/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_ok</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>对feign接口进行实现,来进行服务降级处理(统一服务降级处理)</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentFallbackService</span> <span class="token keyword">implements</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_ok</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;-------PaymentFallbackService fall back-paymentInfo_ok ,o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;-------PaymentFallbackService fall back-paymentInfo_TimeOut ,o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-服务熔断"><a href="#_4-服务熔断" class="header-anchor">#</a> 4.服务熔断 😄</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104866657</p> <p>熔断机制概述：</p> <ul><li><strong>熔断机制是应对雪崩效应的一种微服务链路保护机制</strong>。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。</li> <li><strong>当检测到该节点微服务调用响应正常后，恢复调用链路</strong>。</li></ul> <p>在SpringCloud框架里，熔断机制通过Hystrix实现，Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，缺省是5秒内20次调用失败，就会启动熔断机制。熔断机制的注解是**@HystrixCommand**</p> <h4 id="_1-服务的降级-进而熔断-恢复调用链路"><a href="#_1-服务的降级-进而熔断-恢复调用链路" class="header-anchor">#</a> 1.  服务的降级---&gt;进而熔断---&gt;恢复调用链路</h4> <p>service</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//============= 服务熔断 ===========</span>

<span class="token comment">/**
 * - **熔断机制是应对雪崩效应的一种微服务链路保护机制**。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。
 * - **当检测到该节点微服务调用响应正常后，恢复调用链路**
 * &lt;p&gt;
 * 要求: 10次请求,在10s内失败率达到60%开启断路器
 * HystrixCommandProperties: 主要属性
 */</span>
<span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentCircuitBreaker_fallback&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// 是否开启断路器</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.enabled&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 请求次数</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.requestVolumeThreshold&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 时间窗口期</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.sleepWindowInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 失败率达到多少后跳闸</span>
        <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.errorThresholdPercentage&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;60&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;******id 不能为负数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 等价于 UUID.randomUUID().toString();</span>
    <span class="token comment">// hutool 工具包</span>
    <span class="token class-name">String</span> serialNumber <span class="token operator">=</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">simpleUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;调用成功,流水号: &quot;</span> <span class="token operator">+</span> serialNumber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 兜底方法
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreaker_fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;id 不能负数,请稍后再试,o(╥﹏╥)o id: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>controller</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// ===== 服务熔断 ======</span>

<span class="token comment">/**
 * 服务熔断
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/circuit/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> resutl <span class="token operator">=</span> paymentService<span class="token punctuation">.</span><span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******resukt: &quot;</span> <span class="token operator">+</span> resutl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resutl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>结果:</p> <ul><li>正确: 放行</li> <li>错误; 拦截</li> <li>Controller 调用 Service，请求数10次内出现6次以上错误，就会触发熔断，熔断后正确的请求也不能立刻被响应，而是<strong>缓慢、正确率高了才响应。</strong></li></ul> <p>服务的降级 --&gt; 进而熔断 --&gt; 恢复调用链路</p> <h4 id="_2-结论"><a href="#_2-结论" class="header-anchor">#</a> 2. 结论</h4> <h5 id="_1-熔断类型"><a href="#_1-熔断类型" class="header-anchor">#</a> 1. 熔断类型</h5> <ul><li>熔断打开
请求不再进行调用当前服务，内部设置时钟一般为MTTR（平均故障处理时间），当打开时长达到所设时钟则进入半熔断状态</li> <li>熔断关闭
熔断关闭不会对服务进行调用</li> <li>熔断半开
部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断</li></ul> <h5 id="_2-断路器在什么情况下开始起作用"><a href="#_2-断路器在什么情况下开始起作用" class="header-anchor">#</a> 2. 断路器在什么情况下开始起作用</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155148.png" alt=""></p> <p>设计到断路器的三个重要参数：<strong>快照时间窗</strong>、<strong>请求总数阈值</strong>、<strong>错误百分比阈值</strong></p> <ol><li><p>快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒</p></li> <li><p>请求总数阈值：在快照时间内，必须满足请求总数阈值才有资格熔断。默认为20，意味着在10秒内，如果该hystrix命令的调用次数不足20次，即使所有的请求都超时或其他原因失败，断路器都不会打开</p></li> <li><p>错误百分比阈值：当请求总数在快照时间窗内超过阈值，比如发生了30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超过50%的错误百分比，在默认设定50%阈值情况下，这时候就会将断路器打开</p></li></ol> <h5 id="_3-断路器开启或关闭的条件"><a href="#_3-断路器开启或关闭的条件" class="header-anchor">#</a> 3. 断路器开启或关闭的条件</h5> <ol><li><p>当满足一定的阈值的时候（默认10秒内超过20个请求次数）</p></li> <li><p>当失败率达到一定的时候（默认10秒内超过50%的请求失败）</p></li> <li><p>到达以上阈值，断路器将会开启</p></li> <li><p>当开启的时候，所有请求都不会进行转发</p></li> <li><p>一段时间后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启。重复4和5。</p></li></ol> <h5 id="_4-断路器打开之后"><a href="#_4-断路器打开之后" class="header-anchor">#</a> 4. 断路器打开之后</h5> <ol><li><p><strong>再有请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback</strong>。通过断路器，实现了自动地发现错误并将降级逻辑切换为主逻辑，减少响应延迟的效果。</p></li> <li><p>原来的主逻辑要如何恢复呢？
<strong>对于这一问题，hystrix也为我们实现了自动恢复功能</strong>
当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个休眠时间窗，在这个时间窗内，降级逻辑是临时的成为主逻辑，当休眠时间窗到期，熔断器将进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将继续闭合，主逻辑恢复，如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。</p></li></ol> <h4 id="_3-hystrix相关配置"><a href="#_3-hystrix相关配置" class="header-anchor">#</a> 3. Hystrix相关配置：</h4> <p>https://blog.csdn.net/qq_41211642/article/details/104866657</p> <h3 id="_5-服务限流"><a href="#_5-服务限流" class="header-anchor">#</a> 5. 服务限流</h3> <p>Alibaba - Sentiel 学习</p> <h3 id="_6-hystrix-图形化dashboard搭建及监控测试"><a href="#_6-hystrix-图形化dashboard搭建及监控测试" class="header-anchor">#</a> 6. Hystrix 图形化Dashboard搭建及监控测试</h3> <h4 id="_1-概述-5"><a href="#_1-概述-5" class="header-anchor">#</a> 1 概述</h4> <p>除了隔离依赖服务的调用意外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard），Hystrix会持续的记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少请求多少成功，多少失败等。Netflix 通过 hystrix-metrics-event-stream项目实现了对以上指标的监控。SpringCloud也提供了Hystrix Dashboard的整合，对监控内容转化成可视化界面。</p> <h4 id="_2-编码"><a href="#_2-编码" class="header-anchor">#</a> 2.编码</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code> <span class="token comment">&lt;!-- hystrix仪表盘 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>监控服务需要依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>启动类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableHystrixDashboard</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问</p> <p>http://localhost:9001/hystrix</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155217.png" alt=""></p> <h4 id="_3-新版本hystrix需要在主启动类中指定监控路径"><a href="#_3-新版本hystrix需要在主启动类中指定监控路径" class="header-anchor">#</a> 3. 新版本Hystrix需要在主启动类中指定监控路径</h4> <p>启动类添加  (需要监控服务的启动类)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> 
    <span class="token comment">/**
     * 此配置是为了服务监控而配置，与服务容错本身无关,SpringCloud升级后的坑
     * ServletRegistrationBean因为springboot的默认路径不是&quot;/hystrix.stream&quot;，
     * 只要在自己的项目里配置上下面的servlet就可以了
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span> <span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">HystrixMetricsStreamServlet</span> streamServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixMetricsStreamServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServletRegistrationBean</span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>streamServlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">&quot;/hystrix.stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;HystrixMetricsStreamServlet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155226.png" alt=""></p> <p>监控的地址填写</p> <p>http://localhost:8001/hystrix.stream</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155235.png" alt=""></p> <p>监控页面代表的含义:</p> <p><img src="https://img-blog.csdnimg.cn/20200314232629705.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxMjExNjQy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <hr> <h2 id="_7-网关"><a href="#_7-网关" class="header-anchor">#</a> 7. 网关 😄</h2> <h3 id="_1-zuul-2"><a href="#_1-zuul-2" class="header-anchor">#</a> 1. Zuul</h3> <p>停更 (netflix)</p> <h3 id="_2-gateway-2"><a href="#_2-gateway-2" class="header-anchor">#</a> 2. gateway</h3> <p>spring(自己)</p> <p>https://blog.csdn.net/qq_41211642/article/details/104873418</p> <h4 id="_1-概述-6"><a href="#_1-概述-6" class="header-anchor">#</a> 1.概述</h4> <h5 id="_1-介绍"><a href="#_1-介绍" class="header-anchor">#</a> 1. 介绍</h5> <ul><li><p>官网:  https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/</p></li> <li><p>Cloud 全家桶中有个很重要的组件就是网关，在1.x版本中都是采用的Zuul网关；但在2.x版本中，zuul的升级一直跳票，SpringCloud最后自己研发了一个网关替代Zuul，那就是Spring Cloud Gateway</p></li> <li><p>Gateway是在Spring 生态系统之上构建的API网关服务，基于<strong>Spring 5，SpringBoot 2和Project Reactor等技术</strong>。Gateway旨在提供一种简单而有效的方式来对API进行路由，以及提供一些强大的过滤器功能，例如：<strong>熔断、限流、重试</strong>等。</p></li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/gateway%E5%A5%BD%E5%A4%84.png?x-oss-process=style/shuiyin_1" alt=""></p> <p>总结: <strong>Spring Cloud Gateway 使用的Webflux中的reactor-netty响应式编程组件,底层使用了Netty通讯框架.</strong>(利于高并发,<code>非阻塞式,响应式编程高性能的框架</code>)</p> <h5 id="_2-能干什么-2"><a href="#_2-能干什么-2" class="header-anchor">#</a> 2. 能干什么?</h5> <p><strong>功能：</strong></p> <ul><li>反向代理</li> <li>鉴权</li> <li>流量控制</li> <li>熔断</li> <li>日志监控。。。</li></ul> <h5 id="_3-微服务架构中网关在哪里"><a href="#_3-微服务架构中网关在哪里" class="header-anchor">#</a> 3. 微服务架构中网关在哪里?</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155257.png" alt=""></p> <h5 id="_4-为什么选择gateway"><a href="#_4-为什么选择gateway" class="header-anchor">#</a> 4.  <strong>为什么选择Gateway</strong></h5> <ol><li><p>netflix不太靠谱，zuul 2.0一直跳票，迟迟不发布</p> <ul><li>一方面因为Zuul 1.0已经进入了维护阶段，而且Gateway是SpringCloud团队研发的，值得信赖。而且很多功能Zuul都没有用起来也非常的简单便捷。</li> <li>Gateway是基于异步非阻塞模型上进行开发的，性能方面不需要担心。虽然Netflix早就发布了最新的Zuul 2.x，但SpringCloud貌似没有整合计划。而且Netflix相关组件都宣布进入维护期。</li> <li>多方面综合考虑<strong>Gateway</strong>是很理想的网关选择.</li></ul></li> <li><p>SpringCloud Gateway具有如下特性</p> <ul><li><strong>基于Spring Framework 5，Project Reactor和Spring Boot 2.0构建</strong></li> <li><strong>动态路由</strong>：能够匹配任何请求属性</li> <li>可以对路由指定 Predicate（断言）和Filter（过滤器）</li> <li>集成Hystrix的断路器功能</li> <li>集成Spring Cloud 的服务发现功能</li> <li>易于编写的Predicate（断言）和Filter（过滤器）</li> <li>请求限流功能</li> <li>支持路径重写</li></ul></li> <li><p>SpringCloud Gateway 与 zuul 的区别</p> <p>在SpringCloud Finchley 正式版之前，SpringCloud推荐的网关是Netflix提供的Zuul：</p> <ul><li>Zuul 1.x是一个基于阻塞 I/O 的API Gateway</li> <li>Zuul 1.x基于servlet 2.5使用阻塞架构它不支持任何长连接（如websocket）Zuul的设计模式和Nginx较像，每次I/O 操作都是从工作线程中选择一个执行，请求线程被阻塞到工作线程完成，但是差别是Nginx用C++实现，Zuul用Java实现，而JVM本身会有一次加载较慢的情况，使得zuul的性能相对较差</li> <li>Zuul 2.x理念更先进，向基于Netty非阻塞和支持长连接，但SpringCloud目前还没有整合。Zuul 2.x的性能较Zuul 1.x有较大提升。在性能方面，根据官方提供的基准测试，SpringCloud Gateway的RPS（每秒请求数）是Zuul的1.6倍</li> <li>SpringCloud Gateway建立在Spring Framework5、Project Reactor和Spring Boot 2之上，使用非阻塞API</li> <li>SpringCloud Gateway还支持WebSocket，并且与Spring紧密集成用于更好的开发体验</li></ul></li> <li><p>Gateway模型</p> <p>Gateway支持 <strong>Reactor</strong> 和 <strong>WebFlux</strong></p> <p>传统的Web框架，比如说：struts2，springmvc等都是基于Servlet API与servlet容器基础之上运行的。
但是Servlet3.1之后有了异步非阻塞的支持，而WebFlux是一个典型非阻塞异步的框架，它的核心是基于Reactor的相关API实现的。相对与传统的Web框架来说，它可以运行在诸如Netty，Undertow及支持Servlet3.1的容器上。<strong>非阻塞式+函数式编程</strong></p> <p>Spring WebFlux 是 Spring 5.0引入的新的响应式框架，区别于Spring MVC，它不需要依赖Servlet API，它是完全异步非阻塞的，并且基于 Reactor 来实现响应式流规范</p></li> <li><p>zuul 1.x模型</p> <p>SpringCloud中所集成的Zuul版本，采用的是Tomcat容器，使用的是传统的Servlet IO处理模型。</p> <ol><li><p>Servlet生命周期？
servlet 由 servlet container 进行生命周期管理
container 启动时构造 servlet 对象并调用 servlet init() 进行初始化；
container 运行时接受请求，并为每个请求分配一个线程（一般从线程池中获取空闲线程）然后调用service()；
container 关闭时调用 servlet destory() 销毁servlet；</p></li> <li><p>上述模式的缺点：
servlet是一个简单的网络IO模型，当请求进入servlet container时，servlet container就会为其绑定一个线程，在并发不高的场景下这种模型是适用的。但是一旦高并发（比如用jmeter压测），线程数量就会涨，而线程资源代价是昂贵的（上下文切换，内存消耗大）严重影响请求的处理时间。在一些简单业务场景下，不希望为每个request分配一个线程，只需要1个或几个线程就能应对极大并发的请求，这种业务场景下servlet模型没有优势</p> <p>所以Zuul 1.x是基于servlet之上的一个阻塞式处理模型，即spring实现了处理所有request请求的一个servlet（DispatcherServlet）并由该servlet阻塞式处理。所以SpringCloud Zuul无法摆脱servlet模型的弊端。</p></li></ol></li></ol> <h4 id="_2-gateway-核心概念及工作流程"><a href="#_2-gateway-核心概念及工作流程" class="header-anchor">#</a> 2. Gateway 核心概念及工作流程</h4> <h5 id="_1-核心概念"><a href="#_1-核心概念" class="header-anchor">#</a> 1. 核心概念</h5> <ol><li><p>Route(路由)：路由是构建网关的基本模块，它由ID、目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由</p></li> <li><p>Predicate(断言)：参考的是Java8的java.util.function.Predicate
开发人员可以匹配HTTP请求中的所有内容(例如请求头或请求参数)，如果请求与断言相匹配则进行路由</p></li> <li><p>Filter(过滤)：指的是Spring框架中GatewayFilyter的实例，使用过滤器，可以在请求被路由前或者之后进行修改</p></li></ol> <p>匹配方式就叫断言，实现这个匹配方式就叫filter，对外表现出来就是路由的功能。</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155309.png" alt=""></p> <ul><li>web 请求，通过一些匹配条件，定位到真正的服务节点。并在这个转发过程的前后，进行一些精细化控制。</li> <li>predicate 就是我们的匹配条件，而filter，就可以理解为一个无所不能的拦截器。有了这两个元素再加上目标uri，就可以实现一个具体的路由。</li></ul> <h5 id="_2-gateway工作流程"><a href="#_2-gateway工作流程" class="header-anchor">#</a> 2. gateway工作流程</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155317.png" alt=""></p> <ul><li><p>客户端向Spring Cloud Gateway发出请求。然后在Gateway Handler Mapping中找到与请求相匹配的路由，将其发送到Gateway Web Handler。</p></li> <li><p>Handler再通过指定的过滤器链来讲请求发送到我们实际的服务执行业务逻辑，然后返回。</p></li> <li><p>过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前（“pre”）或之后（“post”）执行业务逻辑</p></li> <li><p>Filter 在 “pre” 类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等；在 “post” 类型的过滤器中可以做响应内容、响应头的修改，日志的输出，流量监控等，有着非常重要的作用</p></li></ul> <p>核心逻辑 ：路由转发 + 执行过滤器链</p> <h3 id="_3-编码"><a href="#_3-编码" class="header-anchor">#</a> 3. 编码</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104874932</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--gateway--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>配置文件</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9527</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token comment"># 网关配置</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh <span class="token comment">#payment_routh    #路由的ID，没有固定规则但要求唯一，简易配合服务名</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>         <span class="token comment">#匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span>          <span class="token comment">#断言，路径相匹配的进行路由</span>

        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh2 <span class="token comment">#payment_routh   #路由的ID，没有固定规则但要求唯一，简易配合服务名</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>          <span class="token comment">#匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>             <span class="token comment">#断言，路径相匹配的进行路由</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>service
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155328.png" alt=""></p> <p>效果</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155334.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155347.png" alt=""></p> <h3 id="_4-gateway网关路由有两种配置方式"><a href="#_4-gateway网关路由有两种配置方式" class="header-anchor">#</a> 4. Gateway网关路由有两种配置方式</h3> <p>https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#route-metadata-configuration</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155357.png" alt=""></p> <h4 id="_1-方式一"><a href="#_1-方式一" class="header-anchor">#</a> 1. 方式一</h4> <p>3中的方式: 在配置文件yml 中配置</p> <h4 id="_2-方式二"><a href="#_2-方式二" class="header-anchor">#</a> 2. 方式二</h4> <p>代码中注入RouteLocator 的Bean</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 通过访问 http://localhost:9527/guonei 来访问 http://news.baidu.com/guonei
     * 通过路由 百度百度网站
     * http://news.baidu.com/guonei
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RouteLocatorBuilder<span class="token punctuation">.</span>Builder</span> routes <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        routes<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;path_route_chggx&quot;</span><span class="token punctuation">,</span>
                r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://news.baidu.com/guonei&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> routes<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>效果</p> <p>http://localhost:9527/guonei</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155409.png" alt=""></p> <h3 id="_5-动态路由"><a href="#_5-动态路由" class="header-anchor">#</a> 5. 动态路由</h3> <h4 id="_1-为什么使用动态路由"><a href="#_1-为什么使用动态路由" class="header-anchor">#</a> 1. 为什么使用动态路由?</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155426.png" alt=""></p> <p>之前访问的路由地址我们是写死的，在微服务架构中，微服务提供者不可能只有一台服务器，就需要动态路由</p> <h4 id="_2-使用思路"><a href="#_2-使用思路" class="header-anchor">#</a> 2. 使用思路</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155419.png" alt=""></p> <ul><li><p>之前80客户端发送请求访问8001/8002，通过ribbon负载均衡，将请求分散，现在服务提供者如果是多台，就需要将ribbon替换为gateway，只暴露gateway，客户端请求统一发到gateway，gateway将请求转发给8001/8002。</p></li> <li><p>默认情况下Gateway会根据注册中心注册的服务列表，以注册中心上微服务名为路径创建动态路由进行转发，从而实现动态路由的功能。</p></li> <li><p>现在启动一个eureka7001，两个服务提供者8001/8002</p></li></ul> <h4 id="_3-编码-2"><a href="#_3-编码-2" class="header-anchor">#</a> 3. 编码</h4> <ol><li><p>修改配置文件</p> <ul><li>开启从注册中心动态创建路由的功能,利用微服务名进行路由</li> <li>使用&quot;lb&quot;动态匹配路由地址</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155440.png" alt=""></p></li></ol> <p>访问 测试</p> <p>http://localhost:9527/payment/get/1</p> <p>8001/8002 切换访问</p> <h3 id="_6-predicate"><a href="#_6-predicate" class="header-anchor">#</a> 6. Predicate</h3> <p>https://blog.csdn.net/qq_41211642/article/details/104879278</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155449.png" alt=""></p> <h4 id="_0-求时区时间"><a href="#_0-求时区时间" class="header-anchor">#</a> 0. 求时区时间</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T2</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 默认时区</span>
        <span class="token class-name">ZonedDateTime</span> zbj <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2020-04-02T10:32:44.384+08:00[Asia/Shanghai]</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zbj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 用于制定时区获取当前时间</span>
<span class="token comment">//        ZonedDateTime zny = ZonedDateTime.now(ZoneId.of(&quot;America/New_york&quot;));</span>
<span class="token comment">//        System.out.println(zny);</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_1-after-时间类型"><a href="#_1-after-时间类型" class="header-anchor">#</a> 1. After  <sup>时间类型</sup></h4> <p>https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gateway-request-predicates-factories</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155457.png" alt=""></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token comment"># 网关配置</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启从注册中心动态创建路由的功能,利用微服务名进行路由(默认false)</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh <span class="token comment">#payment_routh    #路由的ID，没有固定规则但要求唯一，简易配合服务名</span>
          <span class="token comment">#          uri: http://localhost:8001         #匹配后提供服务的路由地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service     <span class="token comment"># 匹配后动态提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span>          <span class="token comment">#断言，路径相匹配的进行路由</span>

        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh2 <span class="token comment">#payment_routh   #路由的ID，没有固定规则但要求唯一，简易配合服务名</span>
            <span class="token comment">#          uri: http://localhost:8001          #匹配后提供服务的路由地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service   <span class="token comment"># 匹配后动态提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>             <span class="token comment">#断言，路径相匹配的进行路由</span>
            <span class="token punctuation">-</span> After=2020<span class="token punctuation">-</span>04<span class="token punctuation">-</span>02T10<span class="token punctuation">:</span>32<span class="token punctuation">:</span>44.384+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>调节时间,只有当前时间在&quot;设置时间之后&quot;才能正常访问</li></ul> <h4 id="_2-before-时间类型"><a href="#_2-before-时间类型" class="header-anchor">#</a> 2. Before  <sup>时间类型</sup></h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155509.png" alt=""></p> <ul><li>调节时间,只有当前时间在&quot;设置时间之前&quot;才能正常访问</li></ul> <h4 id="_3-between-时间类型"><a href="#_3-between-时间类型" class="header-anchor">#</a> 3. Between  <sup>时间类型</sup></h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155516.png" alt=""></p> <ul><li>调节时间,只有当前时间在&quot;设置时间之内&quot;才能正常访问</li></ul> <h4 id="_4-cookie"><a href="#_4-cookie" class="header-anchor">#</a> 4. Cookie</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155527.png" alt=""></p> <p>Cookie Route Predicate: 需要两个参数, ==(Cookie Name,正则表达式)==</p> <p>路由规则会通过获取对应的Cookie Name值和正则表达式去匹配,如果匹配上就会执行路由,如果没有匹配上则不执行</p> <h5 id="_1-yml配置"><a href="#_1-yml配置" class="header-anchor">#</a> 1.  yml配置</h5> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>             <span class="token comment">#断言，路径相匹配的进行路由</span>
  <span class="token punctuation">-</span> After=2020<span class="token punctuation">-</span>04<span class="token punctuation">-</span>02T10<span class="token punctuation">:</span>32<span class="token punctuation">:</span>44.384+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
  <span class="token punctuation">-</span> Cookie=username<span class="token punctuation">,</span>hp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="_2-不带cookie-curl测试"><a href="#_2-不带cookie-curl测试" class="header-anchor">#</a> 2. 不带cookie ==curl测试==</h5> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>curl http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9527/payment/lb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155533.png" alt=""></p> <h5 id="_3-带cookie"><a href="#_3-带cookie" class="header-anchor">#</a> 3. 带cookie</h5> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>curl http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9527/payment/lb <span class="token punctuation">-</span><span class="token punctuation">-</span>cookie &quot;username=hp&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155546.png" alt=""></p> <h4 id="_5-header"><a href="#_5-header" class="header-anchor">#</a> 5. Header</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155549.png" alt=""></p> <p>两个参数: ==(属性名,正则表达式)== 这个属性和正则表达式匹配则执行</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>             <span class="token comment">#断言，路径相匹配的进行路由</span>
            <span class="token punctuation">-</span> After=2020<span class="token punctuation">-</span>04<span class="token punctuation">-</span>02T10<span class="token punctuation">:</span>32<span class="token punctuation">:</span>44.384+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
<span class="token comment">#            - Cookie=username,hp</span>
            <span class="token punctuation">-</span> Header=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>Id<span class="token punctuation">,</span> \d+ <span class="token comment"># 请求头要有&quot;X-Request-Id&quot;属性,并且值为整数的正则表达式</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="_1-测试"><a href="#_1-测试" class="header-anchor">#</a> 1.  测试</h5> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">curl http://localhost:9527/payment/lb -H &quot;X-Request-Id</span><span class="token punctuation">:</span> 1234&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155554.png" alt=""></p> <ul><li>负数报错.</li></ul> <h4 id="_6-host"><a href="#_6-host" class="header-anchor">#</a> 6. Host</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155606.png" alt=""></p> <h4 id="_7-method"><a href="#_7-method" class="header-anchor">#</a> 7. Method</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155613.png" alt=""></p> <h4 id="_8-path"><a href="#_8-path" class="header-anchor">#</a> 8. Path</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155624.png" alt=""></p> <h4 id="_9-query"><a href="#_9-query" class="header-anchor">#</a> 9. Query</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155630.png" alt=""></p> <h4 id="_10-remoteaddr"><a href="#_10-remoteaddr" class="header-anchor">#</a> 10. RemoteAddr</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155644.png" alt=""></p> <h4 id="_11-weight"><a href="#_11-weight" class="header-anchor">#</a> 11. Weight</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155654.png" alt=""></p> <h3 id="_7-filter"><a href="#_7-filter" class="header-anchor">#</a> 7. Filter</h3> <p><a href="https://blog.csdn.net/qq_41211642/article/details/104881451" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><p>路由过滤器可用于修改进入的HTTP请求和返回的HTTP响应，路由过滤器只能指定路由进行使用</p></li> <li><p>SpringCloud Gateway内置了多种路由过滤器，他们都由GatewayFilter的工厂类来生成</p></li> <li><p>SpringCloud Gateway的 Filter，生命周期有 pro 和 post，
种类有GatewayFilter 和 GlobalFilter</p></li> <li><p>常用的GatewayFilter 有31种之多.GlobalFilter 有10个.<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/#gatewayfilter-factories" target="_blank" rel="noopener noreferrer">官网参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <p>这里主要介绍一下==<strong>自定义全局GlobalFilter</strong>==</p> <h4 id="_1-自定义接口"><a href="#_1-自定义接口" class="header-anchor">#</a> 1. 自定义接口</h4> <h5 id="_1-主要接口"><a href="#_1-主要接口" class="header-anchor">#</a> 1. 主要接口</h5> <p><strong>==GlobalFilter,Ordered==</strong></p> <h5 id="_2-能干啥"><a href="#_2-能干啥" class="header-anchor">#</a> 2. 能干啥?</h5> <ul><li>全局日志记录</li> <li>统一网关鉴权</li> <li>......</li></ul> <h5 id="_3-编码-3"><a href="#_3-编码-3" class="header-anchor">#</a> 3.  编码</h5> <ul><li>配置</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh2 <span class="token comment">#payment_routh   #路由的ID，没有固定规则但要求唯一，简易配合服务名</span>
            <span class="token comment">#          uri: http://localhost:8001          #匹配后提供服务的路由地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service   <span class="token comment"># 匹配后动态提供服务的路由地址</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> AddRequestParameter=X<span class="token punctuation">-</span>Requesr<span class="token punctuation">-</span>Id<span class="token punctuation">,</span><span class="token number">1024</span> <span class="token comment"># 过滤器工厂,会在匹配的请求头,加上一对请求头,名称为X-Request-Id值为1024</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>             <span class="token comment">#断言，路径相匹配的进行路由</span>
            <span class="token punctuation">-</span> After=2020<span class="token punctuation">-</span>04<span class="token punctuation">-</span>02T10<span class="token punctuation">:</span>32<span class="token punctuation">:</span>44.384+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
<span class="token comment">#            - Cookie=username,hp</span>
            <span class="token punctuation">-</span> Header=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>Id<span class="token punctuation">,</span> \d+ <span class="token comment"># 请求头要有&quot;X-Request-Id&quot;属性,并且值为整数的正则表达式</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>代码</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLogGatewayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******come in MyLogGatewayFilter: &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******用户名为null,非法用户,o(╥﹏╥)o&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 不被接受</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">NOT_ACCEPTABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 加载过滤器的顺序
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>测试:</p> <p>不带参数</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155706.png" alt=""></p> <p>带参数</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155714.png" alt=""></p> <hr> <h2 id="_8-分布式配置中心"><a href="#_8-分布式配置中心" class="header-anchor">#</a> 8. 分布式配置中心 😄</h2> <h3 id="_1-config-2"><a href="#_1-config-2" class="header-anchor">#</a> 1.  config</h3> <h4 id="_1-概述-7"><a href="#_1-概述-7" class="header-anchor">#</a> 1. 概述</h4> <h5 id="_1-分布式系统面临的问题-配置问题"><a href="#_1-分布式系统面临的问题-配置问题" class="header-anchor">#</a> 1. 分布式系统面临的问题——配置问题</h5> <p>微服务意味着要将单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务。由于每个服务都需要有配置信息才能运行，所以一套集中式的、动态的配置管理设施是必不可少的。SpringCloud提供了ConfigServer来解决这个问题。</p> <p><a href="https://www.springcloud.cc/spring-cloud-config.html" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155721.png" alt=""></p> <p>SpringCloud Config为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为==各个不同微服务应用==的所有环境提供了一个==中心化的外部配置==。</p> <ul><li>实现一处修改,处处使用</li></ul> <h5 id="_2-怎么玩"><a href="#_2-怎么玩" class="header-anchor">#</a> 2. 怎么玩?</h5> <p>SpringCloud Config分为服务端和客户端两部分</p> <p>服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密/解密信息等访问接口</p> <p>客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息，配置服务器默认采用git来存储配置信息，这样就有助于对环境配置进行版本管理，并且可以通过git客户端工具来方便的管理和访问配置内容。</p> <h5 id="_3-能干嘛"><a href="#_3-能干嘛" class="header-anchor">#</a> 3. 能干嘛？</h5> <ul><li>集中管理配置文件</li> <li>不同环境不同配置，动态化的配置更新，分环境部署,比如:dev/test/prod/beta/release</li> <li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取配置自己的信息</li> <li>当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的配置</li> <li>将配置信息以REST接口的形式暴露，post/curl访问刷新即可</li></ul> <h4 id="_2-config-server与client配置与测试及动态刷新"><a href="#_2-config-server与client配置与测试及动态刷新" class="header-anchor">#</a> 2. Config server与client配置与测试及动态刷新</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155734.png" alt=""></p> <p>git命令</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>

<span class="token function">git</span> commit <span class="token parameter variable">-m</span> “内容”

<span class="token function">git</span>  push origin master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>config服务端通过git地址访问github上的文件</p> <p>新建一个项目，上传到github，模拟运维人员进行操作，实现远程与本地的整体一致性。
我的例子是建一个cloud-config仓库，包含三个yml文件，下面会读取文章文件中的信息</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155737.png" alt=""></p> <h5 id="_1-编码"><a href="#_1-编码" class="header-anchor">#</a> 1.  编码</h5> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>配置文件</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3344</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>center
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> git@github.com<span class="token punctuation">:</span>ABirdFree/springcloud<span class="token punctuation">-</span>config.git <span class="token comment">#github仓库上面的git仓库名字</span>
          <span class="token comment">##搜索目录</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> cloud<span class="token punctuation">-</span>config
      <span class="token comment">#读取分支</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka <span class="token comment">#注册进eureka</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>启动类</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigCenterMain3344</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigCenterMain3344</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>修改host文件</li></ul> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">127.0.0.1</span> <span class="token value attr-value">config-3344.com</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问: http://config-3344.com:3344/master/config-dev.yml</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155744.png" alt=""></p> <h5 id="_2-配置读取规则"><a href="#_2-配置读取规则" class="header-anchor">#</a> 2.配置读取规则</h5> <h6 id="_1-方式"><a href="#_1-方式" class="header-anchor">#</a> 1.方式</h6> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>/<span class="token punctuation">{</span>application<span class="token punctuation">}</span>/<span class="token punctuation">{</span>profile<span class="token punctuation">}</span><span class="token punctuation">[</span>/<span class="token punctuation">{</span>label<span class="token punctuation">}</span><span class="token punctuation">]</span>
/<span class="token punctuation">{</span>application<span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">{</span>profile<span class="token punctuation">}</span>.yml
/<span class="token punctuation">{</span>label<span class="token punctuation">}</span>/<span class="token punctuation">{</span>application<span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">{</span>profile<span class="token punctuation">}</span>.yml
/<span class="token punctuation">{</span>application<span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">{</span>profile<span class="token punctuation">}</span>.properties
/<span class="token punctuation">{</span>label<span class="token punctuation">}</span>/<span class="token punctuation">{</span>application<span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">{</span>profile<span class="token punctuation">}</span>.properties
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h6 id="_2-label-application-profile-yml-推荐"><a href="#_2-label-application-profile-yml-推荐" class="header-anchor">#</a> 2.  /{label}/{application}-{profile}.yml <sup>推荐</sup></h6> <p><strong>master分支</strong></p> <p>http://config-3344.com:3344/master/config-dev.yml</p> <p>http://config-3344.com:3344/master/config-prod.yml</p> <p><strong>dev分支</strong></p> <p>http://config-3344.com:3344/dev/config-dev.yml</p> <p>http://config-3344.com:3344/dev/config-prod.yml</p> <h6 id="_3-application-profile-yml"><a href="#_3-application-profile-yml" class="header-anchor">#</a> 3. /{application}-{profile}.yml</h6> <p>http://config-3344.com:3344/config-dev.yml</p> <p>http://config-3344.com:3344/config-prod.yml</p> <h5 id="_3-客户端配置"><a href="#_3-客户端配置" class="header-anchor">#</a> 3. 客户端配置</h5> <p>客户端不直接访问github，而是通过服务端访问。</p> <ul><li>依赖</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>配置文件 bootstrap.yml</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155750.png" alt=""></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3355</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token comment">#Config客户端配置</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master <span class="token comment"># 分支名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> config <span class="token comment"># 配置文件名称</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev <span class="token comment"># 读取后缀名称 上述3个综合：master分支上config-dev.yml的配置文件被读取 http://config-3344.com:3344/master/config-dev.yml</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3344</span> <span class="token comment"># 配置中心地址 表示通过这个服务端访问</span>


<span class="token comment">#服务注册到eureka地址</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001.com/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>启动类</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientMain3355</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigClientMain3355</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>controller 3344以rest风格暴露接口</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token comment">//@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 要访问的3344上的信息
     *  config:
     *   info: &quot;master branch,springcloud-config-test.yml version=1&quot;
     */</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/configInfo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> configInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>效果</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155801.png" alt=""></p> <h5 id="_4-分布式-动态刷新问题"><a href="#_4-分布式-动态刷新问题" class="header-anchor">#</a> 4.  分布式==动态刷新问题==</h5> <h6 id="_1-问题-3"><a href="#_1-问题-3" class="header-anchor">#</a> 1. 问题</h6> <ul><li>linux运维修改GitHub上的配置文件内容做调整</li> <li>刷新3344,发现ConfigServer配置中心立即响应</li> <li>刷新3355,发现ConfigClient客户端没有任何响应</li> <li>3355没有变化,除非自己重启或者重新加载</li> <li>客户端,每次需要重启.......</li></ul> <h6 id="_2-解决-3"><a href="#_2-解决-3" class="header-anchor">#</a> 2.解决</h6> <ul><li>依赖</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>// 监控: 除了网关没,其余都要加
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>暴露监控端点</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment">#添加配置，暴露监控端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>添加注解(在业务上) @RefreshScope</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 要访问的3344上的信息
     *  config:
     *   info: &quot;master branch,springcloud-config-test.yml version=1&quot;
     */</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/configInfo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> configInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li><p>==需要运维人员发送POST请求,刷新3355==</p> <ol><li><p>必修为 ==&quot;POST&quot;== 请求</p></li> <li><p>cmd 进入控制台 curl -X POST &quot;http://localhost:3355/actuator/refresh&quot; ==激活3355,刷新数据===</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155812.png" alt=""></p></li></ol></li> <li><p>效果</p></li> <li><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155817.png" alt=""></p></li></ul> <ol><li>服务端 http://config-3344.com:3344/master/config-dev.yml</li></ol> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155826.png" alt=""></p> <ol start="2"><li>客户端 http://localhost:3355/configInfo</li></ol> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155833.png" alt=""></p> <p>==避免了服务重启==</p> <p>假设有多个微服务客户端3355/3366/3377。。。每个微服务都需要执行一次post请求，可以写一个脚本，批量执行。但是还有没有更优化的方法？</p> <p>我们想大范围的自动刷新，可否广播？一次通知，处处生效？
所以引入了==<strong>SpringCloud Bus</strong>消息总线==，</p> <hr> <h2 id="_9-springcloud-bus消息总线"><a href="#_9-springcloud-bus消息总线" class="header-anchor">#</a> 9. <strong>SpringCloud Bus</strong>消息总线 😄</h2> <h3 id="_1-概述-8"><a href="#_1-概述-8" class="header-anchor">#</a> 1.概述</h3> <h4 id="_1-解决问题"><a href="#_1-解决问题" class="header-anchor">#</a> 1 .解决问题</h4> <ul><li>==实现分布式自动刷新配置功能==</li> <li><strong>SpringCloud Bus</strong> 配合 <strong>SpringCloud Config</strong> 使用,可以实现==配置的动态解析==</li></ul> <h4 id="_2-是什么-能干嘛"><a href="#_2-是什么-能干嘛" class="header-anchor">#</a> 2. 是什么? 能干嘛?</h4> <p>Bus: 支持两种消息代理: RabbitMQ和Kafka</p> <h5 id="_1-利用消息总线触发一个客户端-bus-refresh-而刷新所有客户端的配置"><a href="#_1-利用消息总线触发一个客户端-bus-refresh-而刷新所有客户端的配置" class="header-anchor">#</a> 1. 利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端的配置</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155847.png" alt=""></p> <ul><li>通知一个==客户端==</li></ul> <h5 id="_2-利用消息总线触发一个服务端configserver的-bus-refresh端点-而刷新所有客户端的配置"><a href="#_2-利用消息总线触发一个服务端configserver的-bus-refresh端点-而刷新所有客户端的配置" class="header-anchor">#</a> 2.  利用消息总线触发一个服务端ConfigServer的/bus/refresh端点，而刷新所有客户端的配置</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155854.png" alt=""></p> <ul><li>全部拉取,==全部通知==</li></ul> <p>SpringCloud Bus 能管理和传播分布式系统间的消息,就像一个分布式执行器</p> <p>,可用于广播状态更改.时间推送等,也可以当做微服务间的通信通道</p> <h4 id="_3-什么是总线"><a href="#_3-什么是总线" class="header-anchor">#</a> 3. 什么是总线？</h4> <p>在微服务架构的系统中，通常会使用轻量级的消息代理来构建一个共用的消息主题，并让系统中所有微服务实例都连接上来。由于<strong>该主题中产生的消息会被所有实例监听和消费，所以称它为消息总线</strong>。在总线上的各个实例，都可以方便的广播一些需要让其他连接在该主题上的实例都知道的消息。</p> <h4 id="_4-基本原理"><a href="#_4-基本原理" class="header-anchor">#</a> 4.  基本原理</h4> <p>ConfigClient 实例都监听MQ中同一个topic（默认是springcloubus），当一个服务刷新数据的时候，它会把这个信息放入到Topic中，这样其他监听统一topic的服务就能得到通知，然后去更新自身的配置。</p> <h3 id="_2-rabbitmq配置"><a href="#_2-rabbitmq配置" class="header-anchor">#</a> 2. RabbitMQ配置</h3> <p>基于erlang语言</p> <h3 id="_3-springcloud-bus-动态刷新全局广播"><a href="#_3-springcloud-bus-动态刷新全局广播" class="header-anchor">#</a> 3. SpringCloud Bus==动态刷新全局广播==</h3> <ul><li>先具备良好的 RabbitMQ 环境</li></ul> <h4 id="_1-配置-2"><a href="#_1-配置-2" class="header-anchor">#</a> 1. 配置</h4> <ul><li>依赖(服务端.客户端)</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--添加消息总线RbbitMQ支持--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>服务端3344配置</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>  <span class="token comment">#rabbit相关配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 116.196.118.167
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest

<span class="token comment">#rabbitmq相关配置，暴露bus刷新配置的端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>  <span class="token comment">#暴露bus刷新配置的端点</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'bus-refresh'</span>  <span class="token comment">#凡是暴露监控、刷新的都要有actuator依赖，bus-refresh就是actuator的刷新操作</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>客户端 3355,3366</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>  <span class="token comment">#rabbit相关配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 116.196.118.167
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p>==需要运维人员发送POST请求,刷新3344服务端==</p> <ol><li><p>必修为 ==&quot;POST&quot;== 请求</p></li> <li><p>cmd 进入控制台 curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot; ==激活3344,刷新数据,一次刷新,处处生效==</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155901.png" alt=""></p></li></ol></li> <li><p>效果</p></li> <li><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155905.png" alt=""></p></li></ul> <ol><li>服务端: http://config-3344.com:3344/master/config-dev.yml</li></ol> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155910.png" alt=""></p> <ol start="2"><li>客户端1: http://localhost:3355/configInfo</li></ol> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155917.png" alt=""></p> <ol start="3"><li>客户端2: http://localhost:3366/configInfo</li></ol> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155921.png" alt=""></p> <p>==避免了服务重启==</p> <ul><li>eureka</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155928.png" alt=""></p> <ul><li>rabbitMQ</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155935.png" alt=""><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155942.png" alt=""></p> <p>==一处修改,处处生效===</p> <h4 id="_2-设计思想"><a href="#_2-设计思想" class="header-anchor">#</a> 2. 设计思想</h4> <h5 id="_1-利用消息总线触发一个客户端-bus-refresh-而刷新所有客户端的配置-2"><a href="#_1-利用消息总线触发一个客户端-bus-refresh-而刷新所有客户端的配置-2" class="header-anchor">#</a> 1. 利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端的配置</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223155955.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160001.png" alt=""></p> <h5 id="_2-利用消息总线触发一个服务端configserver的-bus-refresh端点-而刷新所有客户端的配置-2"><a href="#_2-利用消息总线触发一个服务端configserver的-bus-refresh端点-而刷新所有客户端的配置-2" class="header-anchor">#</a> 2. 利用消息总线触发一个服务端ConfigServer的/bus/refresh端点，而刷新所有客户端的配置</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160005.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160010.png" alt=""></p> <p>图二的架构显然更加合适，图一不合适的原因如下：</p> <ul><li>打破了微服务的职责单一性，因为微服务本身是业务模块，它本不应该承担配置刷新的职责</li> <li>破坏了微服务各节点的对等性</li> <li>有一定的局限性。例如，微服务在迁移时，它的网络地址常常会发生变化，此时如果想要做到自动刷新，那就好增加更多的修改</li></ul> <h3 id="_4-springcloud-bus动态刷新-定点通知"><a href="#_4-springcloud-bus动态刷新-定点通知" class="header-anchor">#</a> 4.  SpringCloud Bus动态刷新==定点通知==</h3> <h4 id="_1-定点通知"><a href="#_1-定点通知" class="header-anchor">#</a> 1. ==定点通知==</h4> <ul><li>如果现在不想全部通知，只定向通知,只通知一个,其余不通知</li></ul> <h4 id="_2-解决-4"><a href="#_2-解决-4" class="header-anchor">#</a> <strong>2. 解决</strong>：</h4> <ol><li>指定具体某一个实例生效而不是全部</li> <li>公式：http://localhost:配置中心端口号/actuator/bus-refresh/{destination}</li> <li>/bus/refresh请求不再发送到具体的服务实例上，而是发给 config server并通过destination参数类指定需要更新配置的服务或实例</li></ol> <h4 id="_3-案例"><a href="#_3-案例" class="header-anchor">#</a> 3. 案例</h4> <ol><li><p>刷新运行在3355端口上的config-client为例，只通知3355，不通知3366?</p></li> <li><p>处理</p> <ul><li><p>现在再来修改github配置文件的version，改为3</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160019.png" alt=""></p> <p>3344可以获取数据,3355/3366不能获取处理?</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160023.png" alt=""></p></li> <li><p>执行: curl -X POST &quot;http://localhost:3344/actuator/bus-refresh/config-client:3355&quot; 3355接收数据</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160028.png" alt=""></p></li> <li><p>结果</p> <p>3355</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160035.png" alt=""></p></li></ul></li></ol> <p>​				3366</p> <p>​				<img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160043.png" alt=""></p> <h3 id="_5-bus总结"><a href="#_5-bus总结" class="header-anchor">#</a> 5 bus总结</h3> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160049.png" alt=""></p> <hr> <h2 id="_10-springcloud-stream消息驱动"><a href="#_10-springcloud-stream消息驱动" class="header-anchor">#</a> 10. SpringCloud Stream消息驱动</h2> <h3 id="_1-概述-9"><a href="#_1-概述-9" class="header-anchor">#</a> 1. 概述</h3> <h4 id="_1-简介-官网"><a href="#_1-简介-官网" class="header-anchor">#</a> 1. 简介 <a href="https://spring.io/projects/spring-cloud-stream#overview" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <ul><li>如果系统里同时存在多种MQ，可以使用使用Cloud Stream，只需要和Stream交互就可以进行管理。</li> <li>一句话，==<strong>屏蔽底层消息中间件的差异</strong>，<strong>降低切换成本</strong>，统一消息的编程模型==</li></ul> <h4 id="_2-中文手册"><a href="#_2-中文手册" class="header-anchor">#</a> 2. 中文手册：</h4> <p>官方定义SpringCloud Stream是一个构建<strong>消息驱动微服务的框架</strong></p> <p>应用程序通过inputs 或者 outputs 来与SpringCloud Stream中binder对象交互。通过我们配置来<strong>binding（绑定）</strong>，而SpringCloud Stream的==<strong>binder对象</strong>==负责与消息中间件交互，所以，我们只需要搞清楚如何与SpringCloud Stream交互就可以方便使用消息驱动的方式。</p> <p>通过使用Spring Integration来连接消息代理中间件以实现消息时间驱动
SpringCloud Stream 为一些供应商的消息中间件产品提供了个性化的自动化配置实现，引用了发布-订阅、消费组、分区的三个核心概念。</p> <p>==目前只支持RabbitMQ、Kafka==</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160056.png" alt=""></p> <h3 id="_2-设计思想及理念"><a href="#_2-设计思想及理念" class="header-anchor">#</a> 2.设计思想及理念</h3> <h4 id="_1-mq"><a href="#_1-mq" class="header-anchor">#</a> 1 MQ</h4> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160100.png" alt=""></p> <ol><li>生产者/消费者之间靠==消息==媒介传递信息  ------ Message</li> <li>消息必须走特定的==通道== ------ 消息通道 MessageChannel</li> <li>消息通道里的消息如何被消费呢?谁负责收发==处理==  ----- 消息通道  MessageChannel 的自己扣 SubScribableChannel,有 MessageChannel 消息处理器所订阅.</li></ol> <p>比方说我们用到了RabbitMQ和Kafka，由于这两个消息中间件的架构上的不同，像RabbitMQ有exchange，Kafka有Topic和Partition分区</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160111.png" alt=""></p> <p>这些消息中间件的差异性导致我们实际项目开发给我们造成了一定的困扰，我们如果用了两个消息队列中的一种，后面的业务需求，我们想往另一种消息队列进行迁移，这时候无疑就是灾难性的，一大堆东西都要重新推倒重新做，因为它跟我们的系统耦合了，这时候<strong>SpringCloud Stream给我们提供了一种解耦合的方式</strong></p> <h4 id="_2-如何实现"><a href="#_2-如何实现" class="header-anchor">#</a> 2. 如何实现?</h4> <p>在没有绑定器这个概念的情况下，我们的SpringBoot应用要直接与消息中间件进行信息交互的时候，由于各消息中间件构建的初衷不同，它们的实现细节上会有较大的差异性，通过定义绑定器作为中间层，完美的实现了应用程序与消息中间件细节之间的隔离。通过向应用程序暴露统一的channel通道，使得应用程序不需要再考虑各种不同的消息中间件实现。</p> <p>==通过定义绑定器Binde作为中间层，实现了应用程序与消息中间件细节之间的隔离。==</p> <p>==Binder：INPUT对应于消费者，OUTPUT对应于生产者==</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160124.png" alt=""></p> <p>==Stream中的消息通信方式遵循了发布-订阅模式，Topic主题进行广播（在RabbitMQ就是Exchange，在Kafka是Topic)==</p> <h3 id="_3-流程"><a href="#_3-流程" class="header-anchor">#</a> 3. 流程</h3> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160129.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160134.png" alt=""></p> <ul><li><strong>Binder</strong>：很方便的连接中间件，屏蔽差异</li> <li><strong>Channel</strong>：通道，是队列Queue的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过Channel对队列进行配置</li> <li><strong>Source和Sink</strong>：简单的可以理解为参照对象是SpringCloud Stream自身，从Stream发布消息就是输出，接收消息就是输入</li></ul> <p><strong>编码API和常用注解</strong></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160139.png" alt=""></p> <h3 id="_4-案例-参考"><a href="#_4-案例-参考" class="header-anchor">#</a> 4. 案例 <a href="https://blog.csdn.net/qq_41211642/article/details/104921758" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <h4 id="_1-生产者"><a href="#_1-生产者" class="header-anchor">#</a> 1. 生产者</h4> <ul><li>依赖</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--stream-rabbit--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>配置文件</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8801</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span>  <span class="token comment">#在此配置要绑定的rabbitmq的服务信息</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span>  <span class="token comment">#表示定义的名称，用于binding的整合</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit  <span class="token comment">#消息组件类型</span>
          <span class="token key atrule">environment</span><span class="token punctuation">:</span>  <span class="token comment">#设置rabbitmq的相关环境配置</span>
            <span class="token key atrule">spring</span><span class="token punctuation">:</span>
              <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                <span class="token key atrule">host</span><span class="token punctuation">:</span> 116.196.118.167
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
                <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment">#服务的整合处理</span>
        <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token comment">#这个名字是一个通道的名称</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange  <span class="token comment">#表示要使用的Exchange名称定义</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json  <span class="token comment">#设置消息类型，本次为json，文本则设置“text/plain”</span>
            <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment">#设置要绑定的消息服务的具体设置</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span> <span class="token comment">#客户端进行eureka注册的配置</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token comment">#设置心跳的时间间隔（默认是30秒）</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment">#如果现在超过了5秒的间隔（默认是90秒）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> send<span class="token punctuation">-</span>8801.com  <span class="token comment">#在信息列表时显示主机名称</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>     <span class="token comment">#访问的路径变为IP地址</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ul><li>业务(发送消息)</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 发送消息
     * @return message
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//这不是传统的service,这是和rabbitmq打交道的，不需要加注解@Service</span>
<span class="token comment">//这里不掉dao，去掉消息中间件的service</span>
<span class="token comment">//信道channel和exchange绑定在一起</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProviderImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 消息发送管道
     */</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageChannel</span> output<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 发送消息
     *
     * @return message
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> serial <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******serial: &quot;</span> <span class="token operator">+</span> serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ul><li>controller</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IMessageProvider</span> iMessageProvider<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sendMessage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;*******sendMessage: &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> iMessageProvider<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>测试</li></ul> <p>http://localhost:8801/sendMessage</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160151.png" alt=""></p> <h4 id="_2-消费者-2"><a href="#_2-消费者-2" class="header-anchor">#</a> 2. 消费者</h4> <ul><li>配置</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8802</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment"># 在此处配置要绑定的rabbitMQ的服务信息</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment"># 表示定义的名称，用于binding的整合</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment"># 消息中间件类型</span>
          <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置rabbitMQ的相关环境配置</span>
            <span class="token key atrule">spring</span><span class="token punctuation">:</span>
              <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                <span class="token key atrule">host</span><span class="token punctuation">:</span> 116.196.118.167
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
                <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment"># 服务的整合处理</span>
        <span class="token key atrule">input</span><span class="token punctuation">:</span> <span class="token comment"># 这个名字是一个通道的名称</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment"># 表示要使用的exchange名称定义</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 设置消息类型，本次为json，文本则设为text/plain</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment"># 设置要绑定的消息服务的具体设置</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 设置心跳的间隔时间，默认30</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 超过5秒间隔，默认90</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> receive<span class="token punctuation">-</span>8802.com <span class="token comment">#主机名</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 显示ip</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ul><li>controller(接受消息)</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveMessageListenerController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 监听生产者
     */</span>
    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span><span class="token constant">INPUT</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消费者1号，-------&gt;接收到的消息： &quot;</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t port: &quot;</span> <span class="token operator">+</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>测试</li></ul> <p>http://localhost:8801/sendMessage 3条</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160156.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160200.png" alt=""></p> <h3 id="_5-分组消费与持久化"><a href="#_5-分组消费与持久化" class="header-anchor">#</a> 5. 分组消费与持久化</h3> <h4 id="_1-分组消费"><a href="#_1-分组消费" class="header-anchor">#</a> 1. 分组消费</h4> <h5 id="_1-问题-4"><a href="#_1-问题-4" class="header-anchor">#</a> 1.  问题</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160206.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160210.png" alt=""></p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160215.png" alt=""></p> <p>比如在如下场景中，订单系统我们做集群部署，都会从RabbitMQ中获取订单信息，那如果==一个订单同时被两个服务获取到==，那么就会造成数据错误，我们得避免这种情况，这时我们就可以使用==<strong>Stream中的消息分组</strong>==来解决。</p> <ul><li>注意在Stream中处于同一个group中的多个消费者是竞争关系，就能够保证消息只会被其中一个应用消费一次。</li> <li>==不同组是可以全面消费的（重复消费），同一组内会发送竞争关系，只有其中一个可以消费。==</li></ul> <h5 id="_2-分组"><a href="#_2-分组" class="header-anchor">#</a> 2. 分组</h5> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160223.png" alt=""></p> <h6 id="_1-原理-2"><a href="#_1-原理-2" class="header-anchor">#</a> 1. 原理</h6> <p>微服务应用放置于同一个group中,就能保证消息只会被其中一个应用消费一次.==不同的组是可以消费的,同一个组内会发生竞争关系,只有其中一个可以消费.==</p> <h6 id="_2-解决-5"><a href="#_2-解决-5" class="header-anchor">#</a> 2. 解决</h6> <ol><li><p>8802/8803都变成==不同组==</p> <p>8802: group: chggxA # 分组解决重复消费</p> <p>8803: group: chggxB # 分组解决重复消费</p></li></ol> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160228.png" alt=""></p> <ol start="2"><li>==相同组==</li></ol> <ul><li>8803</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160235.png" alt=""></p> <ul><li>8802</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160240.png" alt=""></p> <ul><li><p>结果</p> <p>生产者</p></li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160246.png" alt=""></p> <p>​         消费者 8802</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160250.png" alt=""></p> <div class="language- extra-class"><pre><code>	消费者 8803
</code></pre></div><p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160254.png" alt=""></p> <h5 id="_3-总结"><a href="#_3-总结" class="header-anchor">#</a> 3. 总结</h5> <p>==同一个组会竞争资源，轮询。不同组会重复消费。==</p> <h4 id="_1-持久化"><a href="#_1-持久化" class="header-anchor">#</a> 1. 持久化</h4> <p>关于自定义分组</p> <p>如果8802去掉分组，而8803不去掉，当8802/8803都关闭服务，8801这时候发送消息，8802再启动的时候不会重新获得未曾获得的消息并消费，而8803重启后会获得8801之前发送的消息并消费。</p> <p>所以==group分组属性在消息重复消费和消息持久化消费 避免消息丢失是非常重要的属性==</p> <p>就是默认的分组不会保留未曾获得的消息，自定义的分组会保留</p> <hr> <h2 id="_11-springcloud-sleuth-分布式请求链路跟踪"><a href="#_11-springcloud-sleuth-分布式请求链路跟踪" class="header-anchor">#</a> 11. SpringCloud Sleuth 分布式请求链路跟踪</h2> <h3 id="_1-概念-官网"><a href="#_1-概念-官网" class="header-anchor">#</a> 1. 概念 <a href="https://cloud.spring.io/spring-cloud-sleuth/reference/html/" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <h4 id="_1-为什么出现-解决了"><a href="#_1-为什么出现-解决了" class="header-anchor">#</a> 1. 为什么出现? 解决了?</h4> <ul><li>问题</li></ul> <p>在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的服务节点调用来协调产生最后的请求结果，每一个前段请求都会形成一条复杂的分布式服务调用链路，链路中的任何一环出现<strong>高延迟</strong>或<strong>错误</strong>都会引起整个请求最后的失败。</p> <h4 id="_2-是什么"><a href="#_2-是什么" class="header-anchor">#</a> 2. 是什么?</h4> <ul><li><strong>SpringCloud Sleuth</strong>提供了一套完整的<strong>服务跟踪</strong>的解决方案</li> <li>在分布式系统中提供追踪解决方案并且兼容支持了zipkin</li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160302.png" alt=""></p> <ul><li>Sleuth 负责收集整理，Zipkin负责展现。</li></ul> <h3 id="_2-环境搭建"><a href="#_2-环境搭建" class="header-anchor">#</a> 2. 环境搭建</h3> <h4 id="_1-zipkin-下载地址"><a href="#_1-zipkin-下载地址" class="header-anchor">#</a> 1. zipkin <a href="https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/" target="_blank" rel="noopener noreferrer">下载地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>SpringCloud从F版起已不需要自己构建Zipkin Server了，只需调用jar包</p> <p>安装: java -jar zipkin-server-2.12.9-exec.jar</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160306.png" alt=""></p> <p>访问: http://localhost:9411/zipkin/</p> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160311.png" alt=""></p> <h4 id="_2-服务搭建"><a href="#_2-服务搭建" class="header-anchor">#</a> 2. 服务搭建</h4> <ul><li>依赖</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--包含了sleuth+zipkin 分布式链路跟踪--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>配置</li></ul> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span> <span class="token comment"># 配置zipkin</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9411</span>
    <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token comment"># 采样率介于0~1之间,1表示全部采集</span>
        <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>controller</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * sleuth分布式链路跟踪测试
 * @return
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/zipkin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentZipkin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hi, i am paymentZipkin server fall back.,welcome to chggx, O(∩_∩)O哈哈~&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><p>测试</p> <ol><li><p>访问上面地址</p> <p>http://localhost/consumer/payment/zipkin</p></li> <li><p>查看<a href="http://localhost:9411/zipkin/" target="_blank" rel="noopener noreferrer">zipkin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol></li></ul> <p><img src="https://chggx-typora.oss-cn-beijing.aliyuncs.com/typora/20210223160317.png" alt=""></p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/16, 00:33:38</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/chggx-knowlodge-vuepress/pages/7bc95c/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">SpringBoot整合Redis</div></a> <a href="/chggx-knowlodge-vuepress/pages/f3ac37/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">SpringCloud Alibaba介绍</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/chggx-knowlodge-vuepress/pages/7bc95c/" class="prev">SpringBoot整合Redis</a></span> <span class="next"><a href="/chggx-knowlodge-vuepress/pages/f3ac37/">SpringCloud Alibaba介绍</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1348088236@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/ABirdFree" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2023
    <span>晨光向 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/chggx-knowlodge-vuepress/assets/js/app.0b8929fd.js" defer></script><script src="/chggx-knowlodge-vuepress/assets/js/2.796b80a3.js" defer></script><script src="/chggx-knowlodge-vuepress/assets/js/90.7e973c3d.js" defer></script>
  </body>
</html>
